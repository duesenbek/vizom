# Page snapshot

```yaml
- generic [active] [ref=e1]:
  - banner [ref=e2]:
    - generic [ref=e3]:
      - navigation [ref=e4]:
        - link "Go to Vizom home" [ref=e5] [cursor=pointer]:
          - /url: index.html
          - img "Vizom Logo" [ref=e6]
          - text: VIZOM
        - generic [ref=e7]:
          - link "Navigate to Home" [ref=e8] [cursor=pointer]:
            - /url: index.html
            - text: Home
          - link "You are viewing the Generator page" [ref=e9] [cursor=pointer]:
            - /url: generator.html
            - text: Generator
          - link "Navigate to Templates" [ref=e10] [cursor=pointer]:
            - /url: templates.html
            - text: Templates
          - link "Navigate to Pricing" [ref=e11] [cursor=pointer]:
            - /url: pricing.html
            - text: Pricing
          - button "Open sign-in dialog" [ref=e12]: Sign In
          - link "Get started with Vizom" [ref=e13] [cursor=pointer]:
            - /url: generator.html
            - text: Get Started
        - button "Toggle mobile navigation" [ref=e14]:
          - generic [ref=e15]: 
      - navigation:
        - generic:
          - link:
            - /url: index.html
            - text: Home
          - link:
            - /url: generator.html
            - text: Generator
          - link:
            - /url: templates.html
            - text: Templates
          - link:
            - /url: pricing.html
            - text: Pricing
          - button: Sign In
          - link:
            - /url: generator.html
            - text: Get Started
  - generic [ref=e17]:
    - complementary [ref=e18]:
      - heading "Chart Type" [level=3] [ref=e19]
      - list [ref=e20]:
        - button "Bar chart" [pressed] [ref=e21]:
          - heading "Bar Chart" [level=4] [ref=e25]
        - button "Line chart" [ref=e26]:
          - heading "Line Chart" [level=4] [ref=e30]
        - button "Pie chart" [ref=e31]:
          - heading "Pie Chart" [level=4] [ref=e35]
        - button "Doughnut chart" [ref=e36]:
          - heading "Doughnut" [level=4] [ref=e40]
        - button "Area chart" [ref=e41]:
          - heading "Area Chart" [level=4] [ref=e45]
        - button "Scatter plot" [ref=e46]:
          - heading "Scatter Plot" [level=4] [ref=e50]
        - button "Bubble chart" [ref=e51]:
          - heading "Bubble Chart" [level=4] [ref=e55]
        - button "Radar chart" [ref=e56]:
          - heading "Radar Chart" [level=4] [ref=e60]
        - button "Polar area chart" [ref=e61]:
          - heading "Polar Area" [level=4] [ref=e65]
        - button "Force graph" [ref=e66]:
          - heading "Force Graph" [level=4] [ref=e68]
        - button "Treemap" [ref=e69]:
          - heading "TreeMap" [level=4] [ref=e71]
        - button "Sankey diagram" [ref=e72]:
          - heading "Sankey" [level=4] [ref=e74]
    - main [ref=e75]:
      - generic [ref=e76]:
        - heading "Describe Your Chart" [level=2] [ref=e77]
        - paragraph [ref=e78]: Tell our AI what kind of chart you want to create.
      - generic [ref=e79]:
        - generic [ref=e80]:
          - text: Chart Description
          - textbox "Chart Description" [ref=e81]:
            - /placeholder: "Example: Create a bar chart showing monthly sales data for Q1 2024 with products A, B, and C. Use blue colors and add a trend line."
          - paragraph [ref=e82]: Describe your chart in plain English. The more detail, the better.
        - button "Generate chart from description" [ref=e83]:
          - generic [ref=e84]: 
          - text: Generate Chart
        - generic [ref=e85]:
          - generic [ref=e86]:
            - heading "Quick Examples" [level=4] [ref=e87]
            - text: Click to try with real data
          - generic [ref=e88]:
            - button "Market Share" [ref=e89]:
              - generic [ref=e92]: Market Share
            - button "Temperature" [ref=e93]:
              - generic [ref=e96]: Temperature
            - button "Quarterly Sales" [ref=e97]:
              - generic [ref=e100]: Quarterly Sales
            - button "Budget" [ref=e101]:
              - generic [ref=e104]: Budget
            - button "Skills" [ref=e105]:
              - generic [ref=e108]: Skills
            - button "Revenue" [ref=e109]:
              - generic [ref=e112]: Revenue
            - button "Age vs Income" [ref=e113]:
              - generic [ref=e116]: Age vs Income
            - button "Daily Activity" [ref=e117]:
              - generic [ref=e120]: Daily Activity
    - complementary [ref=e121]:
      - generic [ref=e122]:
        - heading "Live Preview" [level=2] [ref=e123]
        - generic [ref=e124]:
          - button "Refresh preview area" [ref=e125]:
            - generic [ref=e126]: 
          - button "Enter fullscreen mode" [ref=e127]:
            - generic [ref=e128]: 
      - generic [ref=e129]:
        - generic [ref=e130]:
          - generic [ref=e132]:
            - generic [ref=e133]: 
            - paragraph [ref=e134]: Your chart will appear here
            - paragraph [ref=e135]: Describe your chart and click Generate
          - alert [ref=e136]
        - generic [ref=e137]:
          - heading "Export Options" [level=4] [ref=e138]
          - generic [ref=e139]:
            - button "Open export options" [ref=e140]:
              - generic [ref=e141]: 
              - text: Export
              - generic [ref=e142]: 
            - menu "Export formats":
              - menuitem "Export as PNG image" [ref=e143]:
                - generic [ref=e144]: 
                - generic [ref=e145]:
                  - paragraph [ref=e146]: PNG Image
                  - paragraph [ref=e147]: Download as high-quality PNG
              - menuitem "Export as SVG vector" [ref=e148]:
                - generic [ref=e149]: 
                - generic [ref=e150]:
                  - paragraph [ref=e151]: SVG Vector
                  - paragraph [ref=e152]: Scalable vector export
              - menuitem "Export as PDF document" [ref=e153]:
                - generic [ref=e154]: 
                - generic [ref=e155]:
                  - paragraph [ref=e156]: PDF Document
                  - paragraph [ref=e157]: Best for sharing reports
            - status [ref=e158]
        - generic [ref=e159]:
          - heading "Projects" [level=4] [ref=e160]
          - generic [ref=e161]:
            - button "Save current project" [ref=e162]:
              - generic [ref=e163]: 
              - text: Save Project
            - button "Load saved projects" [ref=e164]:
              - generic [ref=e165]: 
              - text: Load Project
  - generic [ref=e167]:
    - paragraph [ref=e169]: AI is creating your chart...
    - paragraph [ref=e170]: This usually takes 2-3 seconds
  - text: "function ensureScriptOnce(src, globalVar) { if (__loadedScripts.has(src)) return __loadedScripts.get(src); const p = new Promise((resolve, reject) => { if (globalVar && window[globalVar]) return resolve(window[globalVar]); const s = document.createElement('script'); s.src = src; s.async = true; s.onload = () => resolve(globalVar ? window[globalVar] : true); s.onerror = () => reject(new Error('Failed to load: ' + src)); document.head.appendChild(s); }); __loadedScripts.set(src, p); return p; } const COLOR_PALETTES = { default: ['#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#F97316'], vibrant: ['#EF4444', '#F97316', '#FACC15', '#10B981', '#6366F1', '#22D3EE'], professional: ['#1E40AF', '#0EA5E9', '#06B6D4', '#14B8A6', '#0369A1', '#0F172A'], monochrome: ['#111827', '#374151', '#6B7280', '#9CA3AF', '#D1D5DB', '#F3F4F6'], pastel: ['#DBEAFE', '#E0E7FF', '#FCE7F3', '#FEF3C7', '#DCFCE7', '#CCFBF1'] }; const CHART_PRESETS = { minimal: { borderWidth: 2, pointRadius: 3, pointHoverRadius: 5, tension: 0.3, shadowBlur: 0 }, standard: { borderWidth: 3, pointRadius: 6, pointHoverRadius: 8, tension: 0.4, shadowBlur: 8 }, premium: { borderWidth: 4, pointRadius: 8, pointHoverRadius: 10, tension: 0.45, shadowOffsetX: 3, shadowOffsetY: 3, shadowBlur: 12, shadowColor: 'rgba(15, 23, 42, 0.15)' } }; const numberFormatter = new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 2 }); // Register zoom plugin if available if (window.Chart) { try { const zoomPlugin = window['chartjs-plugin-zoom']?.default || window['chartjs-plugin-zoom'] || window.ChartZoom; if (zoomPlugin && typeof zoomPlugin === 'object') { window.Chart.register(zoomPlugin); } window.Chart.defaults.font.family = \"'Inter', sans-serif\"; window.Chart.defaults.color = '#0F172A'; } catch (pluginError) { console.warn('Zoom plugin register failed:', pluginError); } } // Chart Generator Class class ChartGenerator { constructor() { this.aiClient = new window.Deepseek.AIClient(); // Initialize DeepSeek AI client this.ensureDependencies(); this.currentChart = null; this.currentChartType = 'bar'; this.currentLibrary = 'auto'; this.profileSubscription = 'anon'; this.isPro = false; this.lastChartPayload = null; this.projectsKey = 'vizom:generator-projects'; this.projectsCache = this.loadProjectsFromStorage(); this.initializeEventListeners(); this.setupQuickPrompts(); this.setupQuickActions(); this.setupProjectActions(); this.selectChartType(this.currentChartType); this.initializeExporter(); this.initializeAIRecommendations(); this.initializeSubscription(); } ensureDependencies() { // Ensure a basic chartTypes helper exists so generator can work if (!window.chartTypes) { window.chartTypes = { generateSampleData(type) { const labels = ['A', 'B', 'C', 'D']; const data = [12, 19, 3, 5]; return { labels, datasets: [{ label: 'Series', data }] }; } }; } this.chartTypes = window.chartTypes; } async initializeExporter() { try { // Get user data from auth service const userData = await this.getUserData(); await chartExporter.initialize(userData); // Show limits notice for free users if (!chartExporter.isPremium) { chartExporter.showLimitsNotice(); } } catch (error) { console.warn('Failed to initialize exporter:', error); } } initializeAIRecommendations() { this.aiRecommendations = new AIRecommendations(this); } async getUserData() { try { // Try to get user from auth service const { authService } = await import('/src/services/authService.js'); return await authService.getCurrentUser(); } catch (error) { // Return null if not authenticated return null; } } initializeEventListeners() { // Generate button document.getElementById('generate-chart').addEventListener('click', () => { this.generateChart(); }); // Library selector - removed, always use 'auto' // Set default to 'auto' always this.currentLibrary = 'auto'; // Chart type selection with PRO gating const proOnlyTypes = ['sankey']; document.querySelectorAll('.chart-option').forEach(option => { const type = option.dataset.type; const isProOnly = proOnlyTypes.includes(type); if (isProOnly && !this.isPro) { option.dataset.proOnly = 'true'; option.classList.add('opacity-50', 'pointer-events-none', 'relative'); const badge = document.createElement('span'); badge.className = 'absolute top-1 right-1 text-[10px] bg-yellow-400 text-slate-900 rounded px-1 py-0.5'; badge.textContent = 'PRO'; option.appendChild(badge); option.title = 'Unlock with Pro subscription'; } option.addEventListener('click', () => { if (option.dataset.proOnly === 'true' && !this.isPro) { this.showUpgradeModal(); return; } this.selectChartType(type); }); }); this.setupExportMenu(); // Restrict export quality for non-pro const qSel = document.getElementById('pdf-quality'); if (qSel && !this.isPro) { Array.from(qSel.options).forEach((o) => { if (o.value === '2') { o.disabled = true; if (o.selected) { qSel.value = '1'; } } }); } // Refresh preview document.getElementById('refresh-preview').addEventListener('click', () => { this.refreshPreview(); }); // Fullscreen preview document.getElementById('fullscreen-preview').addEventListener('click', () => { this.toggleFullscreen(); }); const watchAdBtn = document.getElementById('watch-ad-btn'); if (watchAdBtn) { watchAdBtn.addEventListener('click', (event) => { event.preventDefault(); this.handleWatchAd(); }); } this.bindUpgradeButtons(); } setupExportMenu() { const controls = document.getElementById('export-controls'); const menuButton = document.getElementById('export-menu-button'); const menu = document.getElementById('export-menu'); if (!controls || !menuButton || !menu) { return; } let isMenuOpen = false; const handleOutsideClick = (event) => { if (!controls.contains(event.target)) { closeMenu(); } }; const handleEscapeKey = (event) => { if (event.key === 'Escape') { closeMenu(); } }; const openMenu = () => { if (isMenuOpen) return; isMenuOpen = true; menu.classList.remove('hidden'); requestAnimationFrame(() => { menu.classList.add('is-open'); }); menuButton.setAttribute('aria-expanded', 'true'); document.addEventListener('click', handleOutsideClick); document.addEventListener('keydown', handleEscapeKey); }; const closeMenu = () => { if (!isMenuOpen) return; isMenuOpen = false; menu.classList.remove('is-open'); menuButton.setAttribute('aria-expanded', 'false'); document.removeEventListener('click', handleOutsideClick); document.removeEventListener('keydown', handleEscapeKey); }; menu.addEventListener('transitionend', (event) => { if (event.propertyName === 'opacity' && !isMenuOpen) { menu.classList.add('hidden'); } }); menu.addEventListener('click', (event) => event.stopPropagation()); menuButton.addEventListener('click', (event) => { event.preventDefault(); event.stopPropagation(); if (isMenuOpen) { closeMenu(); } else { openMenu(); } }); menu.querySelectorAll('.export-menu-option').forEach((option) => { option.addEventListener('click', (event) => { event.preventDefault(); const format = option.dataset.format; closeMenu(); if (format) { this.exportChart(format); } }); }); } setupQuickPrompts() { const promptInput = document.getElementById('prompt-input'); document.querySelectorAll('#quick-prompts [data-prompt]').forEach(btn => { btn.addEventListener('click', () => { const prompt = btn.dataset.prompt || ''; if (promptInput) { promptInput.value = prompt; promptInput.classList.remove('invalid', 'prompt-error-shake'); promptInput.dispatchEvent(new Event('input')); promptInput.focus(); } if (btn.dataset.type) { this.selectChartType(btn.dataset.type); } try { trackEvent('template_used', { templateId: btn.dataset.type || 'prompt_suggestion' }); } catch {} try { trackEvent('quick_prompt_used', { promptSnippet: prompt.slice(0, 48) }); } catch {} // Attempt generation but handle parsing errors gracefully this.generateChart(); }); }); } setupQuickActions() { document.querySelectorAll('[data-action]').forEach(btn => { btn.addEventListener('click', () => { const prompt = btn.dataset.prompt; if (prompt) { document.getElementById('prompt-input').value = prompt; } if (btn.dataset.type) { this.selectChartType(btn.dataset.type); } try { trackEvent('template_used', { templateId: btn.dataset.type || 'quick_action' }); } catch {} this.generateChart(); }); }); } setupProjectActions() { const saveBtn = document.getElementById('save-project'); const loadBtn = document.getElementById('load-projects'); const saveModal = document.getElementById('save-project-modal'); const projectsModal = document.getElementById('projects-modal'); if (saveBtn) { saveBtn.addEventListener('click', () => { if (!this.lastChartPayload) { feedback.showToast('Generate a chart before saving the project', 'warning'); this.highlightPromptInput(); return; } const titleInput = document.getElementById('project-title'); if (titleInput) { titleInput.value = `Project ${new Date().toLocaleString()}`; titleInput.focus(); titleInput.select(); } this.openModal(saveModal); }); } if (loadBtn) { loadBtn.addEventListener('click', () => { this.renderProjectsList(); this.openModal(projectsModal); }); } document.getElementById('confirm-save-project')?.addEventListener('click', () => this.handleProjectSave()); document.getElementById('cancel-save-project')?.addEventListener('click', () => this.closeModal(saveModal)); document.getElementById('close-save-modal')?.addEventListener('click', () => this.closeModal(saveModal)); document.getElementById('close-projects-modal')?.addEventListener('click', () => this.closeModal(projectsModal)); saveModal?.addEventListener('click', (event) => { if (event.target === saveModal) { this.closeModal(saveModal); } }); projectsModal?.addEventListener('click', (event) => { if (event.target === projectsModal) { this.closeModal(projectsModal); } }); this.renderProjectsList(); } selectChartType(type) { if (!type) return; this.currentChartType = type; const options = document.querySelectorAll('.chart-option'); options.forEach(option => { const isActive = option.dataset.type === type; option.setAttribute('aria-pressed', String(isActive)); option.classList.toggle('selected', isActive); option.classList.toggle('border-slate-200', !isActive); }); try { trackEvent('chart_type_selected', { chartType: type }); } catch {} } async initializeSubscription() { try { const { data: { user } } = await supabase.auth.getUser(); if (!user) { this.profileSubscription = 'anon'; this.isPro = false; return; } const { data, error } = await supabase .from('profiles') .select('subscription') .eq('id', user.id) .single(); if (!error && data?.subscription) { this.profileSubscription = data.subscription; this.isPro = String(data.subscription).toLowerCase() === 'pro'; } else { this.profileSubscription = 'free'; this.isPro = false; } } catch (e) { this.profileSubscription = 'anon'; this.isPro = false; } this.aiClient = new DeepSeekClient(); } async generateChart() { const promptInput = document.getElementById('prompt-input'); const prompt = promptInput.value.trim(); if (!prompt) { this.highlightPromptInput(); return; } feedback.showLoading('AI is generating your chart...'); this.clearError(); try { const chartConfig = await this.aiClient.generateChart(prompt, this.currentChartType); this.renderChart(chartConfig); this.lastChartPayload = { prompt, chartType: this.currentChartType, config: chartConfig }; feedback.hideLoading(); } catch (error) { this.handleError(error); } } /** * Handle AI errors with actionable options * @param {string} prompt - Original prompt * @param {Object} error - Error object * @param {Function} onRetry - Retry callback */ handleAIError(prompt, error, onRetry) { // Track error for analytics try { trackEvent('ai_generation_error', { error_code: error?.code, error_message: error?.message, prompt_length: prompt?.length || 0 }); } catch (e) {} // Show enhanced error dialog progressLoading.showAIError(prompt, error, onRetry); } /** * Handle AI recommendations from the API response * @param {Array} recommendations - Array of recommended chart type IDs * @param {string} prompt - Original user prompt */ handleAIRecommendations(recommendations, prompt) { try { // Show AI recommendations UI this.aiRecommendations.show(recommendations, prompt); // Track recommendation shown if (typeof trackEvent === 'function') { trackEvent('ai_recommendations_shown', { recommendations: recommendations, prompt_length: prompt.length, top_recommendation: recommendations[0] }); } } catch (error) { console.warn('Failed to show AI recommendations:', error); } } /** * Generate chart with specific type * @param {string} prompt - User prompt * @param {string} chartType - Chart type to generate */ async generateChartWithSpecificType(prompt, chartType) { try { // Keep generator state in sync with the requested type this.currentChartType = chartType; this.selectChartType(chartType); // Sync the visible prompt field with the provided prompt const promptInput = document.getElementById('prompt-input') || document.getElementById('chart-prompt'); if (promptInput && typeof prompt === 'string') { const trimmed = prompt.trim(); if (trimmed) { promptInput.value = trimmed; promptInput.dispatchEvent(new Event('input')); } } // Reuse the main generation pipeline to avoid undefined client errors await this.generateChart(); } catch (error) { this.handleError(error); } } showUpgradeModal() { if (document.getElementById('pro-overlay')) return; const overlay = document.createElement('div'); overlay.id = 'pro-overlay'; overlay.className = 'fixed inset-0 z-50 bg-black/70 flex items-center justify-center'; const dialog = document.createElement('div'); dialog.className = 'bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 text-center space-y-6'; overlay.appendChild(dialog); const icon = document.createElement('div'); icon.className = 'text-4xl'; dialog.appendChild(icon); const title = document.createElement('h3'); title.className = 'text-xl font-semibold text-slate-900'; title.textContent = 'Unlock Pro Libraries'; dialog.appendChild(title); const description = document.createElement('p'); description.className = 'text-slate-600'; description.textContent = 'Access Plotly, ApexCharts, advanced features, and unlimited generations.'; dialog.appendChild(description); const actions = document.createElement('div'); actions.className = 'space-y-3'; dialog.appendChild(actions); const upgradeBtn = document.createElement('button'); upgradeBtn.className = 'w-full px-4 py-3 bg-slate-900 text-white rounded-lg font-semibold hover:bg-slate-800 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500'; upgradeBtn.dataset.action = 'upgrade-pro'; upgradeBtn.textContent = 'Upgrade to Pro'; actions.appendChild(upgradeBtn); const closeBtn = document.createElement('button'); closeBtn.id = 'close-pro-overlay'; closeBtn.className = 'w-full rounded-lg border border-slate-200 py-2 text-slate-700 hover:border-slate-300 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500'; closeBtn.textContent = 'Not now'; actions.appendChild(closeBtn); document.body.appendChild(overlay); closeBtn.addEventListener('click', ()=> overlay.remove()); overlay.addEventListener('click', (e)=> { if (e.target===overlay) overlay.remove(); }); this.bindUpgradeButtons(overlay); } renderChart(data) { const container = document.getElementById('chart-container'); container.innerHTML = ''; if (!data || !data.type) { const div = document.createElement('div'); div.className = 'text-slate-600'; div.textContent = 'No chart configuration returned.'; container.appendChild(div); return; } const canvas = document.createElement('canvas'); container.appendChild(canvas); const ctx = canvas.getContext('2d'); if (!ctx) { const div = document.createElement('div'); div.className = 'text-slate-600'; div.textContent = 'Canvas is not supported in this environment.'; container.innerHTML = ''; container.appendChild(div); return; } const ChartRef = (typeof Chart !== 'undefined') ? Chart : (typeof window !== 'undefined' ? window.Chart : undefined); if (!ChartRef) { const div = document.createElement('div'); div.className = 'text-slate-600'; div.textContent = 'Chart library is still loading. Please wait a moment and try again.'; container.innerHTML = ''; container.appendChild(div); return; } // Destroy previous chart if any if (this.currentChart && this.currentChart.destroy) { try { this.currentChart.destroy(); } catch {} } // Create Chart.js instance from config this.currentChart = new ChartRef(ctx, data); this.maybeShowWatermark(container); } renderChartFromConfig(config) { const container = document.getElementById('chart-container'); container.innerHTML = ''; if (!config || !config.type) { const div = document.createElement('div'); div.className = 'text-slate-600'; div.textContent = 'No chart configuration returned.'; container.appendChild(div); return; } const canvas = document.createElement('canvas'); container.appendChild(canvas); const ctx = canvas.getContext('2d'); if (!ctx) { const div = document.createElement('div'); div.className = 'text-slate-600'; div.textContent = 'Canvas is not supported in this environment.'; container.innerHTML = ''; container.appendChild(div); return; } const ChartRef = (typeof Chart !== 'undefined') ? Chart : (typeof window !== 'undefined' ? window.Chart : undefined); if (!ChartRef) { const div = document.createElement('div'); div.className = 'text-slate-600'; div.textContent = 'Chart library is still loading. Please wait a moment and try again.'; container.innerHTML = ''; container.appendChild(div); return; } // Destroy previous chart if any if (this.currentChart && this.currentChart.destroy) { try { this.currentChart.destroy(); } catch {} } // Create Chart.js instance from config this.currentChart = new ChartRef(ctx, config); this.maybeShowWatermark(container); } createChart(type, quotaResult) { const container = document.getElementById('chart-container'); container.innerHTML = ''; // Clear previous chart if (quotaResult?.shouldShowAd) { this.showAdOverlay(); } // Create chart based on type if (['bar', 'line', 'pie', 'doughnut', 'area', 'scatter', 'bubble', 'radar', 'polar'].includes(type)) { this.createChartJSChart(type); } else if (['force', 'treemap', 'sankey'].includes(type)) { this.createD3Chart(type); } } async enforceQuota() { try { const response = await fetch('/.netlify/functions/check-quota', { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ action: 'generate-chart' }) }); if (!response.ok) { throw new Error('Quota check failed'); } const result = await response.json(); this.updateQuotaBanner(result); if (!result.allowed) { const msg = result.message || 'Daily generation limit reached.'; try { feedback.showToast(msg, 'warning'); } catch { if (window.uiFeedback?.showToast) { window.uiFeedback.showToast(msg, 'warning'); } else { console.warn('[quota]', msg); } } return result; } return result; } catch (error) { console.warn('Quota check unavailable, proceeding without limits.', error); return { allowed: true, shouldShowAd: false }; } } updateQuotaBanner(result) { const banner = document.getElementById('quota-banner'); const message = document.getElementById('quota-banner-message'); const watchAdBtn = document.getElementById('watch-ad-btn'); if (!banner || !message) return; if (result && result.bannerText) { message.textContent = result.bannerText; } else { message.textContent = `You have ${result?.remaining ?? 'unknown'} generations left today.`; } if (result && result.showBanner) { banner.classList.remove('hidden'); } else { banner.classList.add('hidden'); } if (watchAdBtn) { watchAdBtn.disabled = !result?.canWatchAd; } } handleWatchAd() { this.showAdOverlay(); document.dispatchEvent(new CustomEvent('billing:watchAd')); } bindUpgradeButtons(root = document) { const scope = root || document; scope.querySelectorAll('[data-action=\"upgrade-pro\"]').forEach((btn) => { if (btn.dataset.upgradeBound === 'true') return; btn.dataset.upgradeBound = 'true'; btn.addEventListener('click', (event) => { event.preventDefault(); document.dispatchEvent(new CustomEvent('billing:upgrade')); }); }); } showAdOverlay() { if (document.getElementById('ad-overlay')) { return; } const overlay = document.createElement('div'); overlay.id = 'ad-overlay'; overlay.className = 'fixed inset-0 z-50 bg-black/70 flex items-center justify-center'; const dialog = document.createElement('div'); dialog.className = 'bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-8 text-center space-y-6'; overlay.appendChild(dialog); const icon = document.createElement('div'); icon.className = 'text-4xl'; dialog.appendChild(icon); const title = document.createElement('h3'); title.className = 'text-xl font-semibold text-slate-900'; title.textContent = 'Enjoy a quick break!'; dialog.appendChild(title); const description = document.createElement('p'); description.className = 'text-slate-600'; description.textContent = 'A short ad is playing so you can unlock the next chart. Upgrade to Pro to remove ads and limits.'; dialog.appendChild(description); const actions = document.createElement('div'); actions.className = 'space-y-3'; dialog.appendChild(actions); const upgradeBtn = document.createElement('button'); upgradeBtn.className = 'w-full px-4 py-3 bg-slate-900 text-white rounded-lg font-semibold hover:bg-slate-800 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500'; upgradeBtn.dataset.action = 'upgrade-pro'; upgradeBtn.textContent = 'Upgrade to Pro'; actions.appendChild(upgradeBtn); const closeBtn = document.createElement('button'); closeBtn.id = 'close-ad-overlay'; closeBtn.className = 'w-full rounded-lg border border-slate-200 py-2 text-slate-700 hover:border-slate-300 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500'; closeBtn.textContent = 'Close'; actions.appendChild(closeBtn); document.body.appendChild(overlay); closeBtn.addEventListener('click', () => { overlay.remove(); }); overlay.addEventListener('click', (event) => { if (event.target === overlay) { overlay.remove(); } }); this.bindUpgradeButtons(overlay); } createChartJSChart(type) { const container = document.getElementById('chart-container'); const canvas = document.createElement('canvas'); container.appendChild(canvas); const ctx = canvas.getContext('2d'); if (!ctx) { const div = document.createElement('div'); div.className = 'text-slate-600'; div.textContent = 'Canvas is not supported in this environment.'; container.innerHTML = ''; container.appendChild(div); return; } const ChartRef = (typeof Chart !== 'undefined') ? Chart : (typeof window !== 'undefined' ? window.Chart : undefined); if (!ChartRef) { const div = document.createElement('div'); div.className = 'text-slate-600'; div.textContent = 'Chart library is still loading. Please wait a moment and try again.'; container.innerHTML = ''; container.appendChild(div); return; } const source = this.chartTypes || window.chartTypes; const sample = (source && typeof source.generateSampleData === 'function') ? source.generateSampleData(type) : { labels: ['A','B','C','D'], datasets: [{ label: 'Series', data: [12, 19, 3, 5] }] }; const chartTypeMap = { area: 'line', polar: 'polarArea' }; const chartType = chartTypeMap[type] || type; const config = { type: chartType, data: sample, options: { responsive: true, maintainAspectRatio: false } }; if (this.currentChart && this.currentChart.destroy) { try { this.currentChart.destroy(); } catch {} } this.currentChart = new ChartRef(ctx, config); this.maybeShowWatermark(container); } createD3Chart(type) { const container = document.getElementById('chart-container'); container.innerHTML = ''; const div = document.createElement('div'); div.className = 'text-slate-600'; div.textContent = 'D3-based previews are not available in this environment yet. Please generate the chart using the main Generate button.'; container.appendChild(div); } exportChart(format) { if (!this.currentChart) { try { feedback.showToast('Please generate a chart first', 'warning'); } catch { if (window.uiFeedback?.showToast) { window.uiFeedback.showToast('Please generate a chart first', 'warning'); } else { console.warn('[export] Please generate a chart first'); } } return; } // Export based on format switch (format) { case 'png': this.exportAsPNG(); break; case 'svg': this.exportAsSVG(); break; case 'pdf': this.exportAsPDF(); break; case 'html': this.exportAsHTML(); break; } } async exportAsPNG() { if (!this.currentChart) { try { feedback.showToast('Please generate a chart first', 'warning'); } catch { if (window.uiFeedback?.showToast) { window.uiFeedback.showToast('Please generate a chart first', 'warning'); } else { console.warn('[export] Please generate a chart first'); } } return; } try { const chartInstance = this.currentChart; const filename = 'vizom-chart.png'; if (chartInstance && typeof chartInstance.toBase64Image === 'function') { await chartExporter.exportPNG(chartInstance, filename); } else { const container = document.getElementById('chart-container'); if (!container) { throw new Error('Chart container not found'); } await chartExporter.exportPNG(container, filename); } try { trackEvent('chart_exported', { format: 'png' }); } catch {} } catch (error) { try { ErrorTracker.trackError(error, { context: 'png-export' }); } catch {} const msg = 'Failed to export PNG. Please try again.'; try { feedback.showToast(msg, 'error'); } catch { if (window.uiFeedback?.showToast) { window.uiFeedback.showToast(msg, 'error'); } else { console.error('[export]', msg, error); } } } } async exportAsSVG() { if (!this.currentChart) { try { feedback.showToast('Please generate a chart first', 'warning'); } catch { if (window.uiFeedback?.showToast) { window.uiFeedback.showToast('Please generate a chart first', 'warning'); } else { console.warn('[export] Please generate a chart first'); } } return; } try { const chart = this.currentChart; const filename = 'vizom-chart.svg'; if (chart && typeof chart.toBase64Image === 'function') { await chartExporter.exportSVG(chart, filename); } else if (chart && chart.svg && typeof chart.svg.node === 'function') { const svgData = chart.svg.node().outerHTML; const blob = new Blob([svgData], { type: 'image/svg+xml' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.download = filename; link.href = url; link.click(); URL.revokeObjectURL(url); } else { const container = document.getElementById('chart-container'); if (!container) { throw new Error('Chart container not found'); } await chartExporter.exportSVG(container, filename); } try { trackEvent('chart_exported', { format: 'svg' }); } catch {} } catch (error) { try { ErrorTracker.trackError(error, { context: 'svg-export' }); } catch {} const msg = 'Failed to export SVG. Please try again.'; try { feedback.showToast(msg, 'error'); } catch { if (window.uiFeedback?.showToast) { window.uiFeedback.showToast(msg, 'error'); } else { console.error('[export]', msg, error); } } } } async exportAsPDF() { const container = document.getElementById('chart-container'); const qualitySel = document.getElementById('pdf-quality'); const scale = qualitySel ? Number(qualitySel.value) : 1; if (!container) { const msg = 'Chart container not found'; try { feedback.showToast(msg, 'error'); } catch { if (window.uiFeedback?.showToast) { window.uiFeedback.showToast(msg, 'error'); } else { console.error('[export]', msg); } } return; } try { await exportChartToPDF(container, { filename: 'vizom-chart.pdf', orientation: 'landscape', quality: 0.95, scale }); try { trackEvent('chart_exported', { format: 'pdf' }); } catch {} } catch (error) { try { ErrorTracker.trackError(error, { context: 'pdf-export' }); } catch {} const msg = 'Failed to export PDF. Please try again.'; try { feedback.showToast(msg, 'error'); } catch { if (window.uiFeedback?.showToast) { window.uiFeedback.showToast(msg, 'error'); } else { console.error('[export]', msg, error); } } } } exportAsHTML() { const htmlContent = this.generateHTMLCode(); const blob = new Blob([htmlContent], { type: 'text/html' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.download = 'chart.html'; link.href = url; link.click(); try { trackEvent('chart_exported', { format: 'html' }); } catch {} } generateHTMLCode() { return `"
  - contentinfo
  - generic "Notifications"
```