<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIZOM - AI Chart Generator</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="styles/font-awesome.min.css" />
    
    <!-- Modern Styles -->
    <link rel="stylesheet" href="src/styles/modern-saas.css" />
    <link rel="stylesheet" href="src/styles/components/improvements.css" />
    <link rel="stylesheet" href="src/styles/components/responsive-fixes.css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- D3.js global bridge -->
    <script type="module">
        import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';
        if (typeof window !== 'undefined') {
            window.d3 = d3;
        }
    </script>

    <!-- Supabase client -->
    <script type="module" src="src/supabase-client.js"></script>

    <!-- Supabase auth and payment handlers -->
    <script type="module" src="src/supabase-auth.js"></script>
    <script type="module" src="src/payments/stripe-client.js"></script>
</head>
<style>
    /* Three-Panel Layout Styles */
    .generator-layout {
      display: flex;
      height: calc(100vh - 64px);
      overflow: hidden;
    }

    /* Left Sidebar Styles */
    .left-sidebar {
      width: 320px;
      background: white;
      border-right: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chart-type-card {
      transition: all 0.2s ease;
    }

    .chart-type-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .chart-type-card.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    /* Tab Navigation Styles */
    .tab-nav {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: #f1f5f9;
      border-radius: 8px;
    }

    .tab-button {
      flex: 1;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      transition: all 0.2s ease;
      background: transparent;
      border: none;
      color: #64748b;
      cursor: pointer;
    }

    .tab-button.active {
      background: white;
      color: #3b82f6;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Center Panel Styles */
    .center-panel {
      flex: 1;
      background: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .workspace-header {
      padding: 24px 32px;
      border-bottom: 1px solid #e2e8f0;
    }

    .workspace-content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }

    /* Textarea Styles */
    .prompt-textarea {
      width: 100%;
      height: 256px;
      padding: 24px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      line-height: 1.6;
      resize: none;
      transition: all 0.2s ease;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .prompt-textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    /* Quick Action Buttons */
    .quick-action-btn {
      padding: 8px 16px;
      background: #f1f5f9;
      color: #475569;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .quick-action-btn:hover {
      background: #e2e8f0;
      transform: translateY(-1px);
    }

    /* Generate Button */
    .generate-btn {
      width: 100%;
      padding: 16px;
      background: #3b82f6;
      color: white;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .generate-btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .generate-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Right Sidebar Styles */
    .right-sidebar {
      width: 384px;
      background: white;
      border-left: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-container {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    .chart-preview {
      border: 2px dashed #e2e8f0;
      border-radius: 12px;
      height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8fafc;
      transition: all 0.2s ease;
    }

    .chart-preview.has-chart {
      border-style: solid;
      border-color: #3b82f6;
      background: white;
    }

    .preview-placeholder {
      text-align: center;
      color: #64748b;
    }

    /* Export Controls */
    .export-controls {
      padding: 24px;
      border-top: 1px solid #e2e8f0;
    }

    .format-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .format-btn {
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      background: white;
      color: #475569;
      cursor: pointer;
    }

    .format-btn:hover {
      background: #f1f5f9;
      border-color: #3b82f6;
    }

    .format-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .download-section {
      display: flex;
      gap: 8px;
    }

    .download-btn {
      flex: 1;
      padding: 12px;
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .download-btn:hover {
      background: #2563eb;
    }

    .download-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .share-btn {
      padding: 12px;
      background: white;
      color: #475569;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .share-btn:hover {
      background: #f1f5f9;
      border-color: #3b82f6;
    }

    .share-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Project Management */
    .project-controls {
      padding: 24px;
      border-top: 1px solid #e2e8f0;
    }

    .project-btn {
      width: 100%;
      padding: 12px;
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .project-btn:hover {
      background: #e2e8f0;
      border-color: #3b82f6;
    }

    .project-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .project-btn:last-child {
      margin-bottom: 0;
    }

    .project-btn.primary {
      background: white;
    }

    /* Settings Panel */
    .settings-panel {
      border-top: 1px solid #e2e8f0;
    }

    .settings-toggle {
      width: 100%;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .settings-toggle:hover {
      background: #f8fafc;
    }

    .settings-content {
      padding: 16px 24px;
      border-top: 1px solid #e2e8f0;
    }

    .setting-group {
      margin-bottom: 16px;
    }

    .setting-group:last-child {
      margin-bottom: 0;
    }

    .setting-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #334155;
      margin-bottom: 8px;
    }

    .setting-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: #334155;
    }

    .setting-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #e2e8f0;
      border-radius: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .toggle-switch.active {
      background: #3b82f6;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    /* Loading States */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .loading-spinner {
      margin-bottom: 16px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-container {
      margin: 16px 0;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: #3b82f6;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: #64748b;
    }

    .loading-steps {
      text-align: left;
      margin-top: 16px;
    }

    .step {
      padding: 4px 0;
      font-size: 14px;
      color: #64748b;
      transition: all 0.2s ease;
      position: relative;
      padding-left: 20px;
    }

    .step::before {
      content: "‚óã";
      position: absolute;
      left: 0;
      font-size: 12px;
    }

    .step.active {
      color: #3b82f6;
      font-weight: 500;
    }

    .step.active::before {
      content: "‚óè";
      color: #3b82f6;
    }

    .step.completed {
      color: #10b981;
    }

    .step.completed::before {
      content: "‚úì";
      color: #10b981;
    }

    /* Responsive Design */
    @media (max-width: 1023px) {
      .generator-layout {
        flex-direction: column;
      }

      .left-sidebar,
      .right-sidebar {
        width: 100%;
        height: auto;
        border: none;
        border-bottom: 1px solid #e2e8f0;
      }

      .center-panel {
        flex: 1;
        min-height: 400px;
      }
    }

    @media (max-width: 767px) {
      .workspace-content {
        padding: 16px;
      }

      .prompt-textarea {
        height: 200px;
        padding: 16px;
        font-size: 14px;
      }

      .format-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .quick-action-btn {
        font-size: 12px;
        padding: 6px 12px;
      }
    }

    /* Scrollbar Styling */
    .scrollbar-thin {
      scrollbar-width: thin;
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Validation Feedback */
    .input-feedback {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .input-feedback.valid {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .input-feedback.invalid {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .input-feedback.warning {
      background: #fef3c7;
      color: #d97706;
      border: 1px solid #fde68a;
    }

    .feedback-icon {
      font-size: 16px;
    }

    .feedback-text {
      flex: 1;
    }
  </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-chart-simple"></i>
                    </div>
                    VIZOM
                </a>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle menu">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="nav-links" id="nav-links">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="generator.html" class="nav-link active">Generator</a>
                    <a href="templates.html" class="nav-link">Templates</a>
                    <a href="pricing.html" class="nav-link">Pricing</a>
                    <a href="#" class="nav-link" id="auth-signin">Sign In</a>
                    <a href="#" class="btn btn-primary" id="auth-getstarted" data-action="get-started">Get Started</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Generator -->
    <div class="container">
        <div class="generator-layout">
            <!-- Left: Chart Picker -->
            <aside class="chart-picker">
                <h3 class="section-title">Chart Type</h3>
                <div class="chart-options">
                    <div class="chart-option selected" data-type="bar">
                        <div class="chart-preview">üìä</div>
                        <span class="chart-name">Bar Chart</span>
                    </div>
                    <div class="chart-option" data-type="line">
                        <div class="chart-preview">üìà</div>
                        <span class="chart-name">Line Chart</span>
                    </div>
                    <div class="chart-option" data-type="pie">
                        <div class="chart-preview">üü£</div>
                        <span class="chart-name">Pie Chart</span>
                    </div>
                    <div class="chart-option" data-type="doughnut">
                        <div class="chart-preview">‚≠ï</div>
                        <span class="chart-name">Doughnut</span>
                    </div>
                    <div class="chart-option" data-type="area">
                        <div class="chart-preview">üìâ</div>
                        <span class="chart-name">Area Chart</span>
                    </div>
                    <div class="chart-option" data-type="scatter">
                        <div class="chart-preview">‚ö°</div>
                        <span class="chart-name">Scatter Plot</span>
                    </div>
                    <div class="chart-option" data-type="bubble">
                        <div class="chart-preview">ü´ß</div>
                        <span class="chart-name">Bubble Chart</span>
                    </div>
                    <div class="chart-option" data-type="radar">
                        <div class="chart-preview">üéØ</div>
                        <span class="chart-name">Radar Chart</span>
                    </div>
                    <div class="chart-option" data-type="polar">
                        <div class="chart-preview">üåê</div>
                        <span class="chart-name">Polar Area</span>
                    </div>
                    <div class="chart-option" data-type="force">
                        <div class="chart-preview">üï∏Ô∏è</div>
                        <span class="chart-name">Force Graph</span>
                    </div>
                    <div class="chart-option" data-type="treemap">
                        <div class="chart-preview">üóÇÔ∏è</div>
                        <span class="chart-name">TreeMap</span>
                    </div>
                    <div class="chart-option" data-type="sankey">
                        <div class="chart-preview">üåä</div>
                        <span class="chart-name">Sankey</span>
                    </div>
                </div>
            </aside>

            <!-- Center: Input Panel -->
            <main class="input-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Describe Your Chart</h2>
                    <p class="panel-subtitle">Tell AI what kind of chart you want to create</p>
                </div>

                <div class="panel-content">
                    <!-- Prompt Input -->
                    <div class="input-group">
                        <label class="input-label">Chart Description</label>
                        <textarea 
                            id="prompt-input"
                            class="prompt-textarea"
                            placeholder="Example: Create a bar chart showing monthly sales data for Q1 2024 with products A, B, and C. Use blue colors and add a trend line."
                        ></textarea>
                    </div>

                    <!-- Generate Button -->
                    <button id="generate-chart" class="generate-btn">
                        <i class="fas fa-magic"></i>
                        <span>Generate Chart</span>
                    </button>

                    <!-- Quick Prompts -->
                    <div class="quick-prompts">
                        <h4 class="quick-title">Quick Prompts</h4>
                        <div class="prompt-suggestions">
                            <button class="prompt-btn" data-prompt="Create a pie chart showing market share percentages for tech companies" data-type="pie">
                                üìä Market Share Pie
                            </button>
                            <button class="prompt-btn" data-prompt="Generate a line chart showing temperature trends over 12 months" data-type="line">
                                üìà Temperature Trends
                            </button>
                            <button class="prompt-btn" data-prompt="Build a bar chart comparing sales performance across 4 quarters" data-type="bar">
                                üìâ Sales Comparison
                            </button>
                            <button class="prompt-btn" data-prompt="Create a scatter plot showing correlation between age and income" data-type="scatter">
                                ‚ö° Correlation Plot
                            </button>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right: Preview Panel -->
            <aside class="preview-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Live Preview</h2>
                    <div class="preview-actions">
                        <button id="refresh-preview" class="action-btn" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="fullscreen-preview" class="action-btn" title="Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>

                <div class="panel-content">
                    <!-- Chart Display -->
                    <div class="chart-display">
                        <div id="chart-container" class="chart-container">
                            <div class="empty-state">
                                <i class="fas fa-chart-line empty-icon"></i>
                                <p class="empty-text">Your chart will appear here</p>
                                <p class="empty-subtext">Describe your chart and click Generate</p>
                            </div>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="export-options">
                        <h4 class="export-title">Export Options</h4>
                        <div class="export-buttons">
                            <button class="export-btn" data-format="png">
                                <i class="fas fa-image"></i>
                                PNG
                            </button>
                            <button class="export-btn" data-format="svg">
                                <i class="fas fa-vector-square"></i>
                                SVG
                            </button>
                            <button class="export-btn" data-format="pdf">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                            <button class="export-btn" data-format="html">
                                <i class="fas fa-code"></i>
                                HTML
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">AI is creating your chart...</p>
            <p class="loading-subtext">This usually takes 2-3 seconds</p>
        </div>
    </div>

    <!-- Main Scripts -->
    <script type="module" src="scripts/main.js"></script>
    
    <!-- Generator Script -->
    <script type="module">
        import { chartTypes } from './scripts/core/ChartTypes.js';
        import { d3Visualizations } from './scripts/core/D3Visualizations.js';

        // Chart Generator Class
        class ChartGenerator {
            constructor() {
                this.currentChart = null;
                this.currentChartType = 'bar';
                this.initializeEventListeners();
                this.setupQuickPrompts();
                this.setupQuickActions();
                this.selectChartType(this.currentChartType);
            }

            initializeEventListeners() {
                // Generate button
                document.getElementById('generate-chart').addEventListener('click', () => {
                    this.generateChart();
                });

                // Chart type selection
                document.querySelectorAll('.chart-option').forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectChartType(option.dataset.type);
                    });
                });

                // Export buttons
                document.querySelectorAll('.export-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.exportChart(btn.dataset.format);
                    });
                });

                // Refresh preview
                document.getElementById('refresh-preview').addEventListener('click', () => {
                    this.refreshPreview();
                });

                // Fullscreen preview
                document.getElementById('fullscreen-preview').addEventListener('click', () => {
                    this.toggleFullscreen();
                });

                const watchAdBtn = document.getElementById('watch-ad-btn');
                if (watchAdBtn) {
                    watchAdBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        this.handleWatchAd();
                    });
                }

                this.bindUpgradeButtons();
            }

            setupQuickPrompts() {
                document.querySelectorAll('.prompt-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const prompt = btn.dataset.prompt;
                        document.getElementById('prompt-input').value = prompt;
                        if (btn.dataset.type) {
                            this.selectChartType(btn.dataset.type);
                        }
                        this.generateChart();
                    });
                });
            }

            setupQuickActions() {
                document.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const prompt = btn.dataset.prompt;
                        if (prompt) {
                            document.getElementById('prompt-input').value = prompt;
                        }

                        if (btn.dataset.type) {
                            this.selectChartType(btn.dataset.type);
                        }

                        this.generateChart();
                    });
                });
            }

            selectChartType(type) {
                if (!type) return;
                this.currentChartType = type;
                document.querySelectorAll('.chart-option').forEach(option => {
                    option.classList.toggle('selected', option.dataset.type === type);
                });
            }

            async generateChart() {
                const prompt = document.getElementById('prompt-input').value.trim();
                if (!prompt) {
                    alert('Please describe the chart you want to create');
                    return;
                }

                this.showLoading();

                const quota = await this.enforceQuota();
                if (!quota || quota.allowed === false) {
                    this.hideLoading();
                    return;
                }

                // Simulate AI processing
                setTimeout(() => {
                    this.createChart(this.currentChartType, quota);
                    this.hideLoading();
                }, 2000);
            }

            createChart(type, quotaResult) {
                const container = document.getElementById('chart-container');
                container.innerHTML = ''; // Clear previous chart

                if (quotaResult?.shouldShowAd) {
                    this.showAdOverlay();
                }

                // Create chart based on type
                if (['bar', 'line', 'pie', 'doughnut', 'area', 'scatter', 'bubble', 'radar', 'polar'].includes(type)) {
                    this.createChartJSChart(type);
                } else if (['force', 'treemap', 'sankey'].includes(type)) {
                    this.createD3Chart(type);
                }
            }

            async enforceQuota() {
                try {
                    const response = await fetch('/.netlify/functions/check-quota', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action: 'generate-chart' })
                    });

                    if (!response.ok) {
                        throw new Error('Quota check failed');
                    }

                    const result = await response.json();
                    this.updateQuotaBanner(result);

                    if (!result.allowed) {
                        alert(result.message || 'Daily generation limit reached.');
                        return result;
                    }

                    return result;
                } catch (error) {
                    console.warn('Quota check unavailable, proceeding without limits.', error);
                    return { allowed: true, shouldShowAd: false };
                }
            }

            updateQuotaBanner(result) {
                const banner = document.getElementById('quota-banner');
                const message = document.getElementById('quota-banner-message');
                const watchAdBtn = document.getElementById('watch-ad-btn');

                if (!banner || !message) return;

                if (result && result.bannerText) {
                    message.textContent = result.bannerText;
                } else {
                    message.textContent = `You have ${result?.remaining ?? 'unknown'} generations left today.`;
                }

                if (result && result.showBanner) {
                    banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                }

                if (watchAdBtn) {
                    watchAdBtn.disabled = !result?.canWatchAd;
                }
            }

            handleWatchAd() {
                this.showAdOverlay();
                document.dispatchEvent(new CustomEvent('billing:watchAd'));
            }

            bindUpgradeButtons(root = document) {
                const scope = root || document;
                scope.querySelectorAll('[data-action="upgrade-pro"]').forEach((btn) => {
                    if (btn.dataset.upgradeBound === 'true') return;
                    btn.dataset.upgradeBound = 'true';
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        document.dispatchEvent(new CustomEvent('billing:upgrade'));
                    });
                });
            }

            showAdOverlay() {
                if (document.getElementById('ad-overlay')) {
                    return;
                }

                const overlay = document.createElement('div');
                overlay.id = 'ad-overlay';
                overlay.className = 'fixed inset-0 z-50 bg-black/70 flex items-center justify-center';

                const dialog = document.createElement('div');
                dialog.className = 'bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-8 text-center space-y-6';
                overlay.appendChild(dialog);

                const icon = document.createElement('div');
                icon.className = 'text-4xl';
                icon.textContent = 'üì∫';
                dialog.appendChild(icon);

                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold text-slate-900';
                title.textContent = 'Enjoy a quick break!';
                dialog.appendChild(title);

                const description = document.createElement('p');
                description.className = 'text-slate-600';
                description.textContent = 'A short ad is playing so you can unlock the next chart. Upgrade to Pro to remove ads and limits.';
                dialog.appendChild(description);

                const actions = document.createElement('div');
                actions.className = 'space-y-3';
                dialog.appendChild(actions);

                const upgradeBtn = document.createElement('button');
                upgradeBtn.className = 'w-full px-4 py-3 bg-slate-900 text-white rounded-lg font-semibold hover:bg-slate-800 transition';
                upgradeBtn.dataset.action = 'upgrade-pro';
                upgradeBtn.textContent = 'Upgrade to Pro';
                actions.appendChild(upgradeBtn);

                const closeBtn = document.createElement('button');
                closeBtn.id = 'close-ad-overlay';
                closeBtn.className = 'w-full px-4 py-3 border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition';
                closeBtn.textContent = 'Close';
                actions.appendChild(closeBtn);

                document.body.appendChild(overlay);

                closeBtn.addEventListener('click', () => {
                    overlay.remove();
                });

                overlay.addEventListener('click', (event) => {
                    if (event.target === overlay) {
                        overlay.remove();
                    }
                });

                this.bindUpgradeButtons(overlay);
            }

            createChartJSChart(type) {
                const container = document.getElementById('chart-container');
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);

                const ctx = canvas.getContext('2d');
                const data = chartTypes.generateSampleData(type);

                let chart;
                switch (type) {
                    case 'bar':
                        chart = chartTypes.createBarChart(ctx, data);
                        break;
                    case 'line':
                        chart = chartTypes.createLineChart(ctx, data);
                        break;
                    case 'area':
                        chart = chartTypes.createAreaChart(ctx, data);
                        break;
                    case 'pie':
                        chart = chartTypes.createPieChart(ctx, data);
                        break;
                    case 'doughnut':
                        chart = chartTypes.createDoughnutChart(ctx, data);
                        break;
                    case 'scatter':
                        chart = chartTypes.createScatterChart(ctx, data);
                        break;
                    case 'bubble':
                        chart = chartTypes.createBubbleChart(ctx, data);
                        break;
                    case 'radar':
                        chart = chartTypes.createRadarChart(ctx, data);
                        break;
                    case 'polar':
                        chart = chartTypes.createPolarAreaChart(ctx, data);
                        break;
                }

                this.currentChart = chart;
            }

            createD3Chart(type) {
                const container = document.getElementById('chart-container');
                const data = d3Visualizations.generateSampleData(type);

                let viz;
                switch (type) {
                    case 'force':
                        viz = d3Visualizations.createForceGraph('chart-container', data.nodes, data.links, {
                            width: 350,
                            height: 300
                        });
                        break;
                    case 'treemap':
                        viz = d3Visualizations.createTreeMap('chart-container', data, {
                            width: 350,
                            height: 300
                        });
                        break;
                    case 'sankey':
                        viz = d3Visualizations.createSankeyDiagram('chart-container', data, {
                            width: 350,
                            height: 300
                        });
                        break;
                }

                this.currentChart = viz;
            }

            exportChart(format) {
                if (!this.currentChart) {
                    alert('Please generate a chart first');
                    return;
                }

                // Export based on format
                switch (format) {
                    case 'png':
                        this.exportAsPNG();
                        break;
                    case 'svg':
                        this.exportAsSVG();
                        break;
                    case 'pdf':
                        this.exportAsPDF();
                        break;
                    case 'html':
                        this.exportAsHTML();
                        break;
                }
            }

            exportAsPNG() {
                if (this.currentChart.canvas) {
                    const link = document.createElement('a');
                    link.download = 'chart.png';
                    link.href = this.currentChart.toBase64Image();
                    link.click();
                }
            }

            exportAsSVG() {
                // For D3 charts
                if (this.currentChart && this.currentChart.svg) {
                    const svgData = this.currentChart.svg.node().outerHTML;
                    const blob = new Blob([svgData], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'chart.svg';
                    link.href = url;
                    link.click();
                }
            }

            exportAsPDF() {
                alert('PDF export would be implemented with a library like jsPDF');
            }

            exportAsHTML() {
                const htmlContent = this.generateHTMLCode();
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = 'chart.html';
                link.href = url;
                link.click();
            }

            generateHTMLCode() {
                return `
<!DOCTYPE html>
<html>
<head>
    <title>Generated Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <canvas id="chart" width="400" height="300"></canvas>
    <script>
        // Chart code would go here
    </script>
</body>
</html>`;
            }

            refreshPreview() {
                if (this.currentChartType) {
                    this.createChart(this.currentChartType);
                }
            }

            toggleFullscreen() {
                const container = document.getElementById('chart-container');
                if (!document.fullscreenElement) {
                    container.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            showLoading() {
                document.getElementById('loading-overlay').classList.remove('hidden');
            }

            hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // Initialize the generator when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new ChartGenerator();
        });
    </script>
</body>
</html>

  <!-- Projects Modal -->
  <div id="projects-modal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b border-slate-200">
        <h3 class="text-xl font-semibold text-slate-900">–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h3>
        <button id="close-projects-modal" class="text-slate-400 hover:text-slate-600 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6 overflow-y-auto max-h-[60vh]">
        <div id="projects-list" class="grid gap-4">
          <!-- Projects will be dynamically loaded here -->
        </div>
        <div id="no-projects" class="hidden text-center py-12">
          <i class="fas fa-folder-open text-4xl text-slate-300 mb-4"></i>
          <p class="text-slate-500">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
          <p class="text-sm text-slate-400 mt-2">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Project Modal -->
  <div id="save-project-modal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold text-slate-900">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</h3>
        <button id="close-save-modal" class="text-slate-400 hover:text-slate-600 transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium text-slate-700">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
        <input type="text" id="project-title" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="–ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏ Q1 2024">
      </div>
      <div class="flex gap-3">
        <button id="confirm-save-project" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button id="cancel-save-project" class="flex-1 border border-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:border-slate-300 transition">
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="auth-modal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold text-slate-900">–í—Ö–æ–¥ –≤ VIZOM</h3>
        <button id="close-auth-modal" class="text-slate-400 hover:text-slate-600 transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="text-sm text-slate-500">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—É –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π</p>
      <button id="google-signin" class="w-full inline-flex items-center justify-center gap-2 bg-white border border-slate-200 text-slate-700 px-4 py-3 rounded-lg hover:bg-slate-50 transition">
        <svg class="w-5 h-5" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continue with Google
      </button>
    </div>
  </div>

  </main>

  <!-- Unified Footer -->
  <footer id="unified-footer">
    <!-- Footer content will be dynamically loaded by UnifiedFooter.js -->
  </footer>

  <link rel="stylesheet" href="src/styles/components/footer.css">

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏ –º–æ–¥—É–ª–µ–π -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
  <script>
    // Enhanced loading functions using the LoadingStatesManager
    function showLoading(id = 'chart-generation', config = {}) {
      if (window.loadingStates) {
        const defaultConfig = {
          title: 'AI is generating your chart',
          description: 'This usually takes 5-10 seconds',
          progressBar: true,
          steps: true,
          stepTexts: [
            { text: 'Processing your input', threshold: 30 },
            { text: 'Generating visualization', threshold: 70 },
            { text: 'Finalizing chart', threshold: 100 }
          ],
          showCancel: true,
          timeout: 30000
        };
        
        return window.loadingStates.showLoading(id, { ...defaultConfig, ...config });
      } else {
        // Fallback to basic loading
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.remove('hidden');
          return { hide: () => overlay.classList.add('hidden') };
        }
      }
    }

    function hideLoading(id = 'chart-generation') {
      if (window.loadingStates) {
        return window.loadingStates.hideLoading(id);
      } else {
        // Fallback to basic loading
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.add('hidden');
        }
        return true;
      }
    }

    function updateProgress(id, progress, text) {
      if (window.loadingStates) {
        return window.loadingStates.updateProgress(id, progress, text);
      }
      return false;
    }

    // Example usage with Smart Parse button
    document.addEventListener('DOMContentLoaded', () => {
      const smartParseBtn = document.getElementById('smart-parse-btn');
      
      if (smartParseBtn) {
        smartParseBtn.addEventListener('click', () => {
          // Check if input is ready for generation
          const isReady = window.inputValidation?.isReadyForGeneration('prompt-input');
          
          if (!isReady) {
            // Show validation feedback instead of loading
            const feedback = document.getElementById('input-feedback');
            if (feedback && feedback.classList.contains('hidden')) {
              window.inputValidation?.validate('prompt-input', 'input-feedback');
            }
            return;
          }
          
          // Show enhanced loading
          const loader = showLoading('chart-generation', {
            title: 'AI is generating your chart',
            description: 'Analyzing your data and creating the perfect visualization...',
            steps: true,
            progressBar: true
          });
          
          // Simulate progress updates
          let progress = 0;
          const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            
            if (progress < 30) {
              updateProgress('chart-generation', progress, 'Processing your input...');
            } else if (progress < 70) {
              updateProgress('chart-generation', progress, 'Generating visualization...');
            } else if (progress < 100) {
              updateProgress('chart-generation', progress, 'Finalizing chart...');
            } else {
              progress = 100;
              updateProgress('chart-generation', progress, 'Complete!');
              clearInterval(progressInterval);
              
              // Hide loading after completion
              setTimeout(() => {
                hideLoading('chart-generation');
              }, 1000);
            }
          }, 300);
          
          // Simulate completion after 5 seconds
          setTimeout(() => {
            clearInterval(progressInterval);
            updateProgress('chart-generation', 100, 'Chart generated successfully!');
            setTimeout(() => {
              hideLoading('chart-generation');
            }, 1000);
          }, 5000);
        });
      }

      // Listen for validation events
      document.addEventListener('input:validated', (e) => {
        const { validation } = e.detail;
        
        // Enable/disable smart parse button based on validation
        const smartParseBtn = document.getElementById('smart-parse-btn');
        if (smartParseBtn) {
          if (validation.isValid && validation.score >= 70) {
            smartParseBtn.disabled = false;
            smartParseBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          } else {
            smartParseBtn.disabled = true;
            smartParseBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        }
      });

      // Example with file upload
      const csvUpload = document.getElementById('csv-upload');
      if (csvUpload) {
        csvUpload.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            const loader = showLoading('file-upload', {
              title: 'Processing your file',
              description: 'Analyzing CSV data and preparing for visualization...',
              progressBar: true,
              steps: false
            });
            
            // Simulate file processing
            setTimeout(() => {
              hideLoading('file-upload');
            }, 3000);
          }
        });
      }

      // Example with project save
      const saveProjectBtn = document.getElementById('save-project');
      if (saveProjectBtn) {
        saveProjectBtn.addEventListener('click', () => {
          const buttonLoader = window.loadingStates?.showButtonLoading(saveProjectBtn, 'Saving...');
          
          setTimeout(() => {
            if (buttonLoader) {
              buttonLoader.hide();
            }
          }, 2000);
        });
      }

      // Clear input functionality
      const clearBtn = document.getElementById('clear-input');
      const textarea = document.getElementById('prompt-input');
      
      if (clearBtn && textarea) {
        clearBtn.addEventListener('click', () => {
          textarea.value = '';
          window.inputValidation?.validate('prompt-input', 'input-feedback');
          window.inputValidation?.updateCharCount(textarea, 'char-count');
          textarea.focus();
        });
      }
    });

    // Global error handling for loading timeouts
    window.addEventListener('error', (e) => {
      // Hide any active loading states on error
      if (window.loadingStates) {
        const activeLoaders = window.loadingStates.getActiveLoaders();
        activeLoaders.forEach(id => {
          window.loadingStates.hideLoading(id);
        });
      }
    });
  </script>
  
  <!-- Mobile Menu Script -->
  <script>
    // Mobile menu toggle
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const navLinks = document.getElementById('nav-links');
    
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');
            const icon = mobileMenuToggle.querySelector('i');
            icon.classList.toggle('fa-bars');
            icon.classList.toggle('fa-times');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav') && navLinks.classList.contains('active')) {
                navLinks.classList.remove('active');
                const icon = mobileMenuToggle.querySelector('i');
                icon.classList.add('fa-bars');
                icon.classList.remove('fa-times');
            }
        });
        
        // Close menu when clicking a link
        navLinks.querySelectorAll('a, button').forEach(link => {
            link.addEventListener('click', () => {
                navLinks.classList.remove('active');
                const icon = mobileMenuToggle.querySelector('i');
                icon.classList.add('fa-bars');
                icon.classList.remove('fa-times');
            });
        });
    }
  </script>
</body>
</html>
