<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIZOM - AI Chart Generator</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/vizom-icon.png">
    <link rel="apple-touch-icon" href="/images/vizom-icon.png">

    <!-- Inter font for unified typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS with Vizom brand config -->
    <script>
      window.tailwind = window.tailwind || {};
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'sans-serif'],
            },
            colors: {
              blue: {
                50:  '#F3F7FF',
                100: '#E1EDFF',
                200: '#C2D7FF',
                300: '#9ABFFF',
                400: '#5793FF',
                500: '#2E7BFF',
                600: '#0F6BFF',
                700: '#0852D6',
                800: '#0636A1',
                900: '#041C5C',
              },
            },
          },
        },
      };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=line-clamp"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Modern Styles -->
    <style>
        #export-controls .export-menu {
            opacity: 0;
            transform: translateY(6px) scale(0.98);
            pointer-events: none;
            transition: opacity 140ms ease, transform 140ms ease;
        }

        #export-controls .export-menu.is-open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        #prompt-input.prompt-error-shake {
            animation: prompt-input-shake 0.35s ease;
        }

        @keyframes prompt-input-shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-6px); }
            40%, 80% { transform: translateX(6px); }
        }
    </style>
    
    <!-- Shared vendor bundle: Chart.js, D3, Supabase auth/stripe -->
    <script type="module" src="src/app/vendor-loader.js"></script>

    <!-- Header/auth integration for unified header & ModalSystem -->
    <script type="module" src="src/components/HeaderIntegration.js"></script>

    <!-- DeepSeek AI Client -->
    <script src="https://cdn.jsdelivr.net/npm/deepseek-ai@0.0.3/dist/deepseek-ai.min.js"></script>
</head>
<body class="bg-slate-50 font-sans text-slate-800 antialiased">
    <!-- Header -->
    <header class="sticky top-0 z-50 border-b border-slate-200 bg-white/80 backdrop-blur-lg">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <nav class="flex h-16 items-center justify-between">
                <a href="index.html" class="flex items-center gap-2.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500 rounded-lg" aria-label="Go to Vizom home">
                    <img src="assets/images/logos/vizom-icon.png" alt="Vizom Logo" class="h-8 w-8">
                    <span class="text-xl font-bold text-slate-900">VIZOM</span>
                </a>
                <!-- Desktop Navigation -->
                <div class="hidden items-center gap-8 md:flex">
                    <a href="index.html" class="text-sm font-medium text-slate-600 transition-colors duration-200 hover:text-slate-900 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500" aria-label="Navigate to Home">Home</a>
                    <a href="generator.html" aria-current="page" class="text-sm font-medium text-blue-600 transition-colors duration-200 hover:text-blue-700 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500" aria-label="You are viewing the Generator page">Generator</a>
                    <a href="templates.html" class="text-sm font-medium text-slate-600 transition-colors duration-200 hover:text-slate-900 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500" aria-label="Navigate to Templates">Templates</a>
                    <a href="pricing.html" class="text-sm font-medium text-slate-600 transition-colors duration-200 hover:text-slate-900 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500" aria-label="Navigate to Pricing">Pricing</a>
                    <button class="inline-flex h-10 items-center justify-center whitespace-nowrap rounded-xl px-5 text-sm font-medium text-slate-600 transition-all hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:opacity-50" id="auth-signin" type="button" aria-label="Open sign-in dialog">Sign In</button>
                    <a href="generator.html" data-component="PrimaryButton" class="inline-flex h-10 items-center justify-center whitespace-nowrap rounded-xl bg-blue-600 px-5 text-sm font-medium text-white shadow-sm transition-all hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:opacity-50" data-action="get-started" aria-label="Get started with Vizom">Get Started</a>
                </div>
                <!-- Mobile Menu Toggle -->
                <button class="group inline-flex h-10 w-10 items-center justify-center rounded-xl md:hidden focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500" id="mobile-menu-toggle" aria-label="Toggle mobile navigation" aria-controls="mobile-menu" aria-expanded="false">
                    <i class="fas fa-bars transition-transform duration-200 group-hover:translate-x-0.5"></i>
                </button>
            </nav>
            <!-- Mobile Navigation -->
            <div class="hidden md:hidden -translate-y-2 transition-all duration-200 ease-[cubic-bezier(0.18,0.89,0.32,1.28)] data-[state=open]:translate-y-0 data-[state=closed]:-translate-y-2" id="mobile-menu" data-state="closed">
                <div class="space-y-2 py-4">
                    <a href="index.html" class="block py-2 text-base font-medium text-slate-600 transition-colors duration-200 hover:text-slate-900 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500" aria-label="Navigate to Home">Home</a>
                    <a href="generator.html" aria-current="page" class="block py-2 text-base font-medium text-blue-600 transition-colors duration-200 hover:text-blue-700 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500" aria-label="You are viewing the Generator page">Generator</a>
                    <a href="templates.html" class="block py-2 text-base font-medium text-slate-600 transition-colors duration-200 hover:text-slate-900 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500" aria-label="Navigate to Templates">Templates</a>
                    <a href="pricing.html" class="block py-2 text-base font-medium text-slate-600 transition-colors duration-200 hover:text-slate-900 rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500" aria-label="Navigate to Pricing">Pricing</a>
                    <button class="inline-flex h-10 w-full items-center justify-center whitespace-nowrap rounded-xl bg-slate-100 px-5 text-sm font-medium text-slate-700 transition-all hover:bg-slate-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:opacity-50" id="auth-signin-mobile" type="button" aria-label="Open sign-in dialog">Sign In</button>
                    <a href="generator.html" data-component="PrimaryButton" class="inline-flex h-10 w-full items-center justify-center whitespace-nowrap rounded-xl bg-blue-600 px-5 text-sm font-medium text-white shadow-sm transition-all hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:opacity-50" data-action="get-started" aria-label="Get started with Vizom">Get Started</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Generator -->
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-12">
            <!-- Left: Chart Picker -->
            <aside class="lg:col-span-3 p-6 space-y-6">
                <h3 class="text-sm font-semibold text-slate-900 tracking-wide">Chart Type</h3>
                <div class="grid grid-cols-2 gap-4" role="list" aria-labelledby="chart-type-label">
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-blue-500 ring-2 ring-blue-500 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="bar" aria-pressed="true" aria-label="Bar chart">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-chart-column"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Bar Chart</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="line" aria-pressed="false" aria-label="Line chart">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Line Chart</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="pie" aria-pressed="false" aria-label="Pie chart">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-chart-pie"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Pie Chart</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="doughnut" aria-pressed="false" aria-label="Doughnut chart">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-circle-notch"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Doughnut</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="area" aria-pressed="false" aria-label="Area chart">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-chart-area"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Area Chart</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="scatter" aria-pressed="false" aria-label="Scatter plot">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-bolt"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Scatter Plot</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="bubble" aria-pressed="false" aria-label="Bubble chart">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-circle"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Bubble Chart</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="radar" aria-pressed="false" aria-label="Radar chart">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-bullseye"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Radar Chart</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="polar" aria-pressed="false" aria-label="Polar area chart">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-circle-nodes"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Polar Area</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="force" aria-pressed="false" aria-label="Force graph">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-share-nodes"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Force Graph</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="treemap" aria-pressed="false" aria-label="Treemap">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-table-cells-large"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">TreeMap</h4>
                        </div>
                    </button>
                    <button class="chart-option flex flex-col gap-2 overflow-hidden rounded-xl border border-slate-200 bg-white text-left transition hover:shadow-sm hover:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-type="sankey" aria-pressed="false" aria-label="Sankey diagram">
                        <div class="h-24 flex items-center justify-center text-4xl bg-slate-50">
                            <i class="fa-solid fa-water"></i>
                        </div>
                        <div class="p-4">
                            <h4 class="font-semibold text-sm line-clamp-1">Sankey</h4>
                        </div>
                    </button>
                </div>
            </aside>

            <!-- Center: Input Panel -->
            <main class="lg:col-span-6 p-6 space-y-6">
                <div class="space-y-2">
                    <h2 class="text-2xl font-bold text-slate-900">Describe Your Chart</h2>
                    <p class="text-slate-600">Tell our AI what kind of chart you want to create.</p>
                </div>

                <div class="space-y-6">
                    <!-- Prompt Input -->
                    <div class="space-y-2">
                        <label for="prompt-input" class="text-sm font-medium text-slate-700">Chart Description</label>
                        <textarea 
                            id="prompt-input"
                            data-testid="prompt-input"
                            aria-describedby="prompt-helper"
                            class="h-48 w-full resize-none rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm text-slate-800 shadow-sm placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                            placeholder="Example: Create a bar chart showing monthly sales data for Q1 2024 with products A, B, and C. Use blue colors and add a trend line."
                        ></textarea>
                        <p id="prompt-helper" class="text-xs text-slate-500" data-default-text="Describe your chart in plain English. The more detail, the better.">Describe your chart in plain English. The more detail, the better.</p>
                    </div>


                    <!-- Generate Button -->
                    <button id="generate-chart" class="group inline-flex w-full h-12 items-center justify-center gap-2 whitespace-nowrap rounded-xl bg-blue-600 px-6 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-testid="generate-button" aria-label="Generate chart from description">
                        <i class="fas fa-magic"></i>
                        <span>Generate Chart</span>
                    </button>

                    <!-- Quick Prompts -->
                    <div class="space-y-3">
                        <div class="flex items-center gap-2 flex-wrap">
                            <h4 class="text-sm font-medium text-slate-700">Quick Prompts</h4>
                            <span class="text-xs text-slate-500" id="prompt-format-hint">Use data like&nbsp;<code>[{&quot;label&quot;:&quot;Jan&quot;,&quot;value&quot;:10}]</code> or <code>{&quot;labels&quot;:[&quot;Jan&quot;,&quot;Feb&quot;],&quot;data&quot;:[10,20]}</code></span>
                        </div>
                        <div class="flex flex-wrap gap-3" id="quick-prompts">
                            <button class="inline-flex h-10 items-center justify-center rounded-xl bg-white px-4 text-sm font-medium text-slate-700 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" data-prompt='{"labels":["Apple","Google","Microsoft","Amazon"],"data":[35,28,22,15]}' data-type="pie">
                                <i class="fa-solid fa-chart-pie mr-2"></i>
                                Market Share Pie
                            </button>
                            <button class="inline-flex h-10 items-center justify-center rounded-xl bg-white px-4 text-sm font-medium text-slate-700 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" data-prompt='{"labels":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"data":[-2,0,4,9,14,19,22,21,17,10,4,0]}' data-type="line">
                                <i class="fa-solid fa-chart-line mr-2"></i>
                                Temperature Trends
                            </button>
                            <button class="inline-flex h-10 items-center justify-center rounded-xl bg-white px-4 text-sm font-medium text-slate-700 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" data-prompt='{"labels":["Q1","Q2","Q3","Q4"],"data":[180,220,260,310]}' data-type="bar">
                                <i class="fa-solid fa-chart-column mr-2"></i>
                                Sales Comparison
                            </button>
                            <button class="inline-flex h-10 items-center justify-center rounded-xl bg-white px-4 text-sm font-medium text-slate-700 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" data-prompt='{"labels":["25","30","35","40","45","50"],"data":[32,45,51,63,70,78]}' data-type="scatter">
                                <i class="fa-solid fa-bolt mr-2"></i>
                                Correlation Plot
                            </button>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right: Preview Panel -->
            <aside class="lg:col-span-3 p-6 space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-slate-900">Live Preview</h2>
                    <div class="flex items-center gap-2">
                        <button id="refresh-preview" class="group inline-flex h-10 items-center justify-center rounded-xl px-3 text-sm font-medium text-slate-700 hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" title="Refresh" aria-label="Refresh preview area">
                            <i class="fas fa-sync-alt transition-transform duration-200 group-hover:translate-x-0.5"></i>
                        </button>
                        <button id="fullscreen-preview" class="group inline-flex h-10 items-center justify-center rounded-xl px-3 text-sm font-medium text-slate-700 hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" title="Fullscreen" aria-label="Enter fullscreen mode">
                            <i class="fas fa-expand transition-transform duration-200 group-hover:translate-x-0.5"></i>
                        </button>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Chart Display -->
                    <div class="aspect-[16/10] bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 flex items-center justify-center">
                        <div id="chart-container" class="w-full h-full" data-testid="chart-container">
                            <div class="flex flex-col items-center justify-center h-full text-slate-500">
                                <i class="fas fa-chart-line text-4xl mb-4"></i>
                                <p class="font-medium">Your chart will appear here</p>
                                <p class="text-sm">Describe your chart and click Generate</p>
                            </div>
                        </div>
                        <div id="generation-error" data-testid="error-message" class="hidden text-red-600 text-sm mt-2" role="alert" aria-live="assertive"></div>
                    </div>

                    <!-- Export Options -->
                    <div class="space-y-3">
                        <h4 class="text-sm font-medium text-slate-700">Export Options</h4>
                        <div class="relative flex flex-col gap-2" id="export-controls">
                            <button id="export-menu-button" type="button" class="group export-btn inline-flex w-full h-11 items-center justify-center gap-2 whitespace-nowrap rounded-xl bg-blue-600 px-4 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" data-testid="export-main-button" aria-haspopup="menu" aria-expanded="false" aria-controls="export-menu" aria-label="Open export options">
                                <i class="fas fa-download transition-transform duration-200 group-hover:translate-x-0.5"></i>
                                <span>Export</span>
                                <i class="fas fa-chevron-down text-xs transition-transform duration-200 group-hover:translate-x-0.5"></i>
                            </button>
                            <div id="export-menu" class="export-menu hidden absolute top-full left-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-lg z-20 min-w-[220px] transition-all duration-[140ms] ease-out" role="menu" aria-label="Export formats">
                                <button class="group export-menu-option w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 flex items-start gap-3" data-format="png" role="menuitem" aria-label="Export as PNG image">
                                    <i class="fas fa-image text-gray-600 transition-transform duration-200 group-hover:translate-x-0.5"></i>
                                    <div>
                                        <p class="text-sm font-medium text-slate-800">PNG Image</p>
                                        <p class="text-xs text-slate-500">Download as high-quality PNG</p>
                                    </div>
                                </button>
                                <button class="group export-menu-option w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 flex items-start gap-3" data-format="svg" role="menuitem" aria-label="Export as SVG vector">
                                    <i class="fas fa-vector-square text-gray-600 mt-0.5 transition-transform duration-200 group-hover:translate-x-0.5"></i>
                                    <div>
                                        <p class="text-sm font-medium text-slate-800">SVG Vector</p>
                                        <p class="text-xs text-slate-500">Scalable vector export</p>
                                    </div>
                                </button>
                                <button class="group export-menu-option w-full text-left px-4 py-3 rounded-lg transition hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 flex items-start gap-3" data-format="pdf" role="menuitem" aria-label="Export as PDF document">
                                    <i class="fas fa-file-pdf text-gray-600 transition-transform duration-200 group-hover:translate-x-0.5"></i>
                                    <div>
                                        <p class="text-sm font-medium text-slate-800">PDF Document</p>
                                        <p class="text-xs text-slate-500">Best for sharing reports</p>
                                    </div>
                                </button>
                            </div>
                            <p id="export-feedback" class="hidden text-xs font-medium" role="status" aria-live="polite"></p>
                        </div>
                    </div>

                    <!-- Project Actions -->
                    <div class="space-y-3">
                        <h4 class="text-sm font-medium text-slate-700">Projects</h4>
                        <div class="grid gap-2">
                            <button id="save-project" type="button" class="group inline-flex h-11 items-center justify-center gap-2 whitespace-nowrap rounded-xl bg-slate-900 px-4 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" aria-label="Save current project">
                                <i class="fas fa-save transition-transform duration-200 group-hover:translate-x-0.5"></i>
                                <span>Save Project</span>
                            </button>
                            <button id="load-projects" type="button" class="group inline-flex h-11 items-center justify-center gap-2 whitespace-nowrap rounded-xl bg-white px-4 text-sm font-medium text-slate-700 shadow-sm ring-1 ring-inset ring-slate-200 transition hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2" aria-label="Load saved projects">
                                <i class="fas fa-folder-open transition-transform duration-200 group-hover:translate-x-0.5"></i>
                                <span>Load Project</span>
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden" data-testid="loading-overlay" role="presentation" aria-hidden="true">
        <div class="loading-content">
            <div class="loading-spinner" data-testid="loading-spinner"></div>
            <p class="loading-text" data-testid="loading-message">AI is creating your chart...</p>
            <p class="loading-subtext">This usually takes 2-3 seconds</p>
        </div>
    </div>

    <!-- Main Scripts -->
    <script type="module" src="scripts/main.js"></script>
    
    <!-- Generator Script -->
    <script type="module">
        import { supabase } from './src/supabase-client.js';
        import { ErrorTracker } from './src/tracking/error-tracking.stub.js';
        import { trackEvent } from './src/tracking/analytics.stub.js';
        import { ChartExporter } from './src/utils/ChartExporter.js';
        import { exportChartToPDF } from './src/utils/export-pdf.js';
        import { chartExporter } from './src/utils/ChartExporter.js';
        import { AIRecommendations } from './src/components/AIRecommendations.js';
        import { progressLoading } from './src/components/ProgressLoadingManager.js';
        import { OptimizedChartTypeSelector } from './src/components/OptimizedChartTypeSelector.js';
        import { simpleParse } from './src/utils/simple-parser.js';
        import { showLoading as showGlobalLoading, hideLoading as hideGlobalLoading, showToast as showGlobalToast } from './scripts/core/ui-feedback.js';

        const noop = () => {};
        const feedback = {
          showLoading: showGlobalLoading || noop,
          hideLoading: hideGlobalLoading || noop,
          showToast: showGlobalToast || ((message) => console.info('[toast]', message))
        };

        // Simple script loader with caching
        const __loadedScripts = new Map();
        function ensureScriptOnce(src, globalVar) {
            if (__loadedScripts.has(src)) return __loadedScripts.get(src);
            const p = new Promise((resolve, reject) => {
                if (globalVar && window[globalVar]) return resolve(window[globalVar]);
                const s = document.createElement('script');
                s.src = src; s.async = true;
                s.onload = () => resolve(globalVar ? window[globalVar] : true);
                s.onerror = () => reject(new Error('Failed to load: ' + src));
                document.head.appendChild(s);
            });
            __loadedScripts.set(src, p);
            return p;
        }

        const COLOR_PALETTES = {
            default: ['#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#F97316'],
            vibrant: ['#EF4444', '#F97316', '#FACC15', '#10B981', '#6366F1', '#22D3EE'],
            professional: ['#1E40AF', '#0EA5E9', '#06B6D4', '#14B8A6', '#0369A1', '#0F172A'],
            monochrome: ['#111827', '#374151', '#6B7280', '#9CA3AF', '#D1D5DB', '#F3F4F6'],
            pastel: ['#DBEAFE', '#E0E7FF', '#FCE7F3', '#FEF3C7', '#DCFCE7', '#CCFBF1']
        };

        const CHART_PRESETS = {
            minimal: {
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                tension: 0.3,
                shadowBlur: 0
            },
            standard: {
                borderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 8,
                tension: 0.4,
                shadowBlur: 8
            },
            premium: {
                borderWidth: 4,
                pointRadius: 8,
                pointHoverRadius: 10,
                tension: 0.45,
                shadowOffsetX: 3,
                shadowOffsetY: 3,
                shadowBlur: 12,
                shadowColor: 'rgba(15, 23, 42, 0.15)'
            }
        };

        const numberFormatter = new Intl.NumberFormat('en-US', {
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        });

        // Register zoom plugin if available
        if (window.Chart) {
            try {
                const zoomPlugin = window['chartjs-plugin-zoom']?.default || window['chartjs-plugin-zoom'] || window.ChartZoom;
                if (zoomPlugin && typeof zoomPlugin === 'object') {
                    window.Chart.register(zoomPlugin);
                }

                window.Chart.defaults.font.family = "'Inter', sans-serif";
                window.Chart.defaults.color = '#0F172A';
            } catch (pluginError) {
                console.warn('Zoom plugin register failed:', pluginError);
            }
        }

        // Chart Generator Class
        class ChartGenerator {
            constructor() {
                this.aiClient = new window.Deepseek.AIClient(); // Initialize DeepSeek AI client
                this.ensureDependencies();
                this.currentChart = null;
                this.currentChartType = 'bar';
                this.currentLibrary = 'auto';
                this.profileSubscription = 'anon';
                this.isPro = false;
                this.lastChartPayload = null;
                this.projectsKey = 'vizom:generator-projects';
                this.projectsCache = this.loadProjectsFromStorage();
                this.initializeEventListeners();
                this.setupQuickPrompts();
                this.setupQuickActions();
                this.setupProjectActions();
                this.selectChartType(this.currentChartType);
                this.initializeExporter();
                this.initializeAIRecommendations();
                this.initializeSubscription();
            }

            ensureDependencies() {
                // Ensure a basic chartTypes helper exists so generator can work
                if (!window.chartTypes) {
                    window.chartTypes = {
                        generateSampleData(type) {
                            const labels = ['A', 'B', 'C', 'D'];
                            const data = [12, 19, 3, 5];
                            return {
                                labels,
                                datasets: [{
                                    label: 'Series',
                                    data
                                }]
                            };
                        }
                    };
                }

                this.chartTypes = window.chartTypes;
            }

            async initializeExporter() {
                try {
                    // Get user data from auth service
                    const userData = await this.getUserData();
                    await chartExporter.initialize(userData);
                    
                    // Show limits notice for free users
                    if (!chartExporter.isPremium) {
                        chartExporter.showLimitsNotice();
                    }
                } catch (error) {
                    console.warn('Failed to initialize exporter:', error);
                }
            }

            initializeAIRecommendations() {
                this.aiRecommendations = new AIRecommendations(this);
            }

            async getUserData() {
                try {
                    // Try to get user from auth service
                    const { authService } = await import('/src/services/authService.js');
                    return await authService.getCurrentUser();
                } catch (error) {
                    // Return null if not authenticated
                    return null;
                }
            }

            initializeEventListeners() {
                // Generate button
                document.getElementById('generate-chart').addEventListener('click', () => {
                    this.generateChart();
                });

                // Library selector
                const libSel = document.getElementById('chart-library');
                if (libSel) {
                    libSel.addEventListener('change', (e) => {
                        const value = e.target.value;
                        if (['apexcharts','plotly'].includes(value) && !this.isPro) {
                            this.showUpgradeModal();
                            e.target.value = 'chartjs';
                            this.currentLibrary = 'chartjs';
                            return;
                        }
                        this.currentLibrary = value;
                    });
                }
                // Disable PRO-only libraries when not pro
                if (libSel && !this.isPro) {
                    Array.from(libSel.options).forEach((opt) => {
                        if (opt.getAttribute('data-pro-only') !== null) {
                            opt.disabled = true;
                            opt.textContent = (opt.textContent || '') + ' â€¢ PRO';
                        }
                    });
                }

                // Chart type selection with PRO gating
                const proOnlyTypes = ['sankey'];
                document.querySelectorAll('.chart-option').forEach(option => {
                    const type = option.dataset.type;
                    const isProOnly = proOnlyTypes.includes(type);
                    if (isProOnly && !this.isPro) {
                        option.dataset.proOnly = 'true';
                        option.classList.add('opacity-50', 'pointer-events-none', 'relative');
                        const badge = document.createElement('span');
                        badge.className = 'absolute top-1 right-1 text-[10px] bg-yellow-400 text-slate-900 rounded px-1 py-0.5';
                        badge.textContent = 'PRO';
                        option.appendChild(badge);
                        option.title = 'Unlock with Pro subscription';
                    }
                    option.addEventListener('click', () => {
                        if (option.dataset.proOnly === 'true' && !this.isPro) {
                            this.showUpgradeModal();
                            return;
                        }
                        this.selectChartType(type);
                    });
                });

                this.setupExportMenu();
                // Restrict export quality for non-pro
                const qSel = document.getElementById('pdf-quality');
                if (qSel && !this.isPro) {
                    Array.from(qSel.options).forEach((o) => {
                        if (o.value === '2') {
                            o.disabled = true;
                            if (o.selected) { qSel.value = '1'; }
                        }
                    });
                }

                // Refresh preview
                document.getElementById('refresh-preview').addEventListener('click', () => {
                    this.refreshPreview();
                });

                // Fullscreen preview
                document.getElementById('fullscreen-preview').addEventListener('click', () => {
                    this.toggleFullscreen();
                });

                const watchAdBtn = document.getElementById('watch-ad-btn');
                if (watchAdBtn) {
                    watchAdBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        this.handleWatchAd();
                    });
                }

                this.bindUpgradeButtons();
            }

            setupExportMenu() {
                const controls = document.getElementById('export-controls');
                const menuButton = document.getElementById('export-menu-button');
                const menu = document.getElementById('export-menu');
                if (!controls || !menuButton || !menu) {
                    return;
                }

                let isMenuOpen = false;

                const handleOutsideClick = (event) => {
                    if (!controls.contains(event.target)) {
                        closeMenu();
                    }
                };

                const handleEscapeKey = (event) => {
                    if (event.key === 'Escape') {
                        closeMenu();
                    }
                };

                const openMenu = () => {
                    if (isMenuOpen) return;
                    isMenuOpen = true;
                    menu.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        menu.classList.add('is-open');
                    });
                    menuButton.setAttribute('aria-expanded', 'true');
                    document.addEventListener('click', handleOutsideClick);
                    document.addEventListener('keydown', handleEscapeKey);
                };

                const closeMenu = () => {
                    if (!isMenuOpen) return;
                    isMenuOpen = false;
                    menu.classList.remove('is-open');
                    menuButton.setAttribute('aria-expanded', 'false');
                    document.removeEventListener('click', handleOutsideClick);
                    document.removeEventListener('keydown', handleEscapeKey);
                };

                menu.addEventListener('transitionend', (event) => {
                    if (event.propertyName === 'opacity' && !isMenuOpen) {
                        menu.classList.add('hidden');
                    }
                });

                menu.addEventListener('click', (event) => event.stopPropagation());

                menuButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    if (isMenuOpen) {
                        closeMenu();
                    } else {
                        openMenu();
                    }
                });

                menu.querySelectorAll('.export-menu-option').forEach((option) => {
                    option.addEventListener('click', (event) => {
                        event.preventDefault();
                        const format = option.dataset.format;
                        closeMenu();
                        if (format) {
                            this.exportChart(format);
                        }
                    });
                });
            }

            setupQuickPrompts() {
                const promptInput = document.getElementById('prompt-input');
                document.querySelectorAll('#quick-prompts [data-prompt]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const prompt = btn.dataset.prompt || '';
                        if (promptInput) {
                            promptInput.value = prompt;
                            promptInput.classList.remove('invalid', 'prompt-error-shake');
                            promptInput.dispatchEvent(new Event('input'));
                            promptInput.focus();
                        }

                        if (btn.dataset.type) {
                            this.selectChartType(btn.dataset.type);
                        }

                        try { trackEvent('template_used', { templateId: btn.dataset.type || 'prompt_suggestion' }); } catch {}
                        try { trackEvent('quick_prompt_used', { promptSnippet: prompt.slice(0, 48) }); } catch {}

                        // Attempt generation but handle parsing errors gracefully
                        this.generateChart();
                    });
                });
            }

            setupQuickActions() {
                document.querySelectorAll('[data-action]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const prompt = btn.dataset.prompt;
                        if (prompt) {
                            document.getElementById('prompt-input').value = prompt;
                        }

                        if (btn.dataset.type) {
                            this.selectChartType(btn.dataset.type);
                        }

                        try { trackEvent('template_used', { templateId: btn.dataset.type || 'quick_action' }); } catch {}
                        this.generateChart();
                    });
                });
            }

            setupProjectActions() {
                const saveBtn = document.getElementById('save-project');
                const loadBtn = document.getElementById('load-projects');
                const saveModal = document.getElementById('save-project-modal');
                const projectsModal = document.getElementById('projects-modal');

                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        if (!this.lastChartPayload) {
                            feedback.showToast('Generate a chart before saving the project', 'warning');
                            this.highlightPromptInput();
                            return;
                        }
                        const titleInput = document.getElementById('project-title');
                        if (titleInput) {
                            titleInput.value = `Project ${new Date().toLocaleString()}`;
                            titleInput.focus();
                            titleInput.select();
                        }
                        this.openModal(saveModal);
                    });
                }

                if (loadBtn) {
                    loadBtn.addEventListener('click', () => {
                        this.renderProjectsList();
                        this.openModal(projectsModal);
                    });
                }

                document.getElementById('confirm-save-project')?.addEventListener('click', () => this.handleProjectSave());
                document.getElementById('cancel-save-project')?.addEventListener('click', () => this.closeModal(saveModal));
                document.getElementById('close-save-modal')?.addEventListener('click', () => this.closeModal(saveModal));
                document.getElementById('close-projects-modal')?.addEventListener('click', () => this.closeModal(projectsModal));

                saveModal?.addEventListener('click', (event) => {
                    if (event.target === saveModal) {
                        this.closeModal(saveModal);
                    }
                });

                projectsModal?.addEventListener('click', (event) => {
                    if (event.target === projectsModal) {
                        this.closeModal(projectsModal);
                    }
                });

                this.renderProjectsList();
            }

            selectChartType(type) {
                if (!type) return;
                this.currentChartType = type;
                document.querySelectorAll('.chart-option').forEach(option => {
                    const isActive = option.dataset.type === type;
                    option.setAttribute('aria-pressed', String(isActive));
                    // Reset visual state
                    option.classList.remove('ring-2','ring-blue-500','border-blue-500','border-slate-200','selected');
                    if (isActive) {
                        option.classList.add('ring-2','ring-blue-500','border-blue-500','selected');
                    } else {
                        option.classList.add('border-slate-200');
                    }
                });
                try { trackEvent('chart_type_selected', { chartType: type }); } catch {}
            }

            async initializeSubscription() {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) { this.profileSubscription = 'anon'; this.isPro = false; return; }
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('subscription')
                        .eq('id', user.id)
                        .single();
                    if (!error && data?.subscription) {
                        this.profileSubscription = data.subscription;
                        this.isPro = String(data.subscription).toLowerCase() === 'pro';
                    } else {
                        this.profileSubscription = 'free';
                        this.isPro = false;
                    }
                } catch (e) {
                    this.profileSubscription = 'anon';
                    this.isPro = false;
                }

                this.aiClient = new DeepSeekClient({
                    // Initialize with your DeepSeek API key
                    apiKey: 'YOUR_API_KEY',
                });
            }

            async generateChart() {
                const promptInput = document.getElementById('prompt-input');
                const prompt = promptInput.value.trim();

                if (!prompt) {
                    this.highlightPromptInput();
                    return;
                }

                feedback.showLoading('AI is generating your chart...');
                this.clearError();

                try {
                    const chartConfig = await this.aiClient.generateChart(prompt, this.currentChartType);
                    this.renderChart(chartConfig);
                    this.lastChartPayload = { prompt, chartType: this.currentChartType, config: chartConfig };
                    feedback.hideLoading();
                } catch (error) {
                    this.handleError(error);
                }
            }

            /**
             * Handle AI errors with actionable options
             * @param {string} prompt - Original prompt
             * @param {Object} error - Error object
             * @param {Function} onRetry - Retry callback
             */
            handleAIError(prompt, error, onRetry) {
                // Track error for analytics
                try {
                    trackEvent('ai_generation_error', {
                        error_code: error?.code,
                        error_message: error?.message,
                        prompt_length: prompt?.length || 0
                    });
                } catch (e) {}

                // Show enhanced error dialog
                progressLoading.showAIError(prompt, error, onRetry);
            }

            /**
             * Handle AI recommendations from the API response
             * @param {Array} recommendations - Array of recommended chart type IDs
             * @param {string} prompt - Original user prompt
             */
            handleAIRecommendations(recommendations, prompt) {
                try {
                    // Show AI recommendations UI
                    this.aiRecommendations.show(recommendations, prompt);
                    
                    // Track recommendation shown
                    if (typeof trackEvent === 'function') {
                        trackEvent('ai_recommendations_shown', {
                            recommendations: recommendations,
                            prompt_length: prompt.length,
                            top_recommendation: recommendations[0]
                        });
                    }
                } catch (error) {
                    console.warn('Failed to show AI recommendations:', error);
                }
            }

            /**
             * Generate chart with specific type
             * @param {string} prompt - User prompt
             * @param {string} chartType - Chart type to generate
             */
            async generateChartWithSpecificType(prompt, chartType) {
                try {
                    // Keep generator state in sync with the requested type
                    this.currentChartType = chartType;
                    this.selectChartType(chartType);

                    // Sync the visible prompt field with the provided prompt
                    const promptInput =
                        document.getElementById('prompt-input') ||
                        document.getElementById('chart-prompt');
                    if (promptInput && typeof prompt === 'string') {
                        const trimmed = prompt.trim();
                        if (trimmed) {
                            promptInput.value = trimmed;
                            promptInput.dispatchEvent(new Event('input'));
                        }
                    }

                    // Reuse the main generation pipeline to avoid undefined client errors
                    await this.generateChart();
                } catch (error) {
                    this.handleError(error);
                }
            }

            async renderWithLibrary(lib, type, chartJsConfig) {
                try {
                    const container = document.getElementById('chart-container');
                    container.innerHTML = '';
                    // basic sample data if no config mapping
                    const source = this.chartTypes || window.chartTypes;
                    const sample = (source && typeof source.generateSampleData === 'function')
                        ? source.generateSampleData(type)
                        : { labels: ['A','B','C','D'], datasets: [{ label: 'Series', data: [12, 19, 3, 5] }] };

                    if (lib === 'chartjs') {
                        this.renderChart(chartJsConfig);
                        return true;
                    }

                    if (lib === 'echarts') {
                        await ensureScriptOnce('https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js', 'echarts');
                        const el = document.createElement('div');
                        el.style.width = '100%'; el.style.height = '360px';
                        container.appendChild(el);
                        const inst = window.echarts.init(el);
                        const option = this.buildEChartsOption(type, sample);
                        inst.setOption(option);
                        this.currentChart = inst;
                        this.maybeShowWatermark(container);
                        return true;
                    }

                    if (lib === 'apexcharts') {
                        await ensureScriptOnce('https://cdn.jsdelivr.net/npm/apexcharts', 'ApexCharts');
                        const el = document.createElement('div');
                        container.appendChild(el);
                        const options = this.buildApexOption(type, sample);
                        const chart = new window.ApexCharts(el, options);
                        await chart.render();
                        this.currentChart = chart;
                        this.maybeShowWatermark(container);
                        return true;
                    }

                    if (lib === 'plotly') {
                        await ensureScriptOnce('https://cdn.plot.ly/plotly-2.27.0.min.js', 'Plotly');
                        const el = document.createElement('div');
                        container.appendChild(el);
                        const payload = this.buildPlotlyPayload(type, sample);
                        await window.Plotly.newPlot(el, payload.data, payload.layout, { displayModeBar: true });
                        this.currentChart = el;
                        this.maybeShowWatermark(container);
                        return true;
                    }

                    return false;
                } catch (e) {
                    console.warn('Library render failed, falling back to Chart.js', e);
                    return false;
                }
            }

            buildEChartsOption(type, sample) {
                const { labels, datasets } = sample;
                const data = datasets[0]?.data || [];
                if (['bar','line','area'].includes(type)) {
                    return {
                        tooltip: {}, xAxis: { type: 'category', data: labels }, yAxis: { type: 'value' },
                        series: [{ type: type === 'area' ? 'line' : type, data, areaStyle: type==='area'?{}:undefined }]
                    };
                }
                if (['pie','doughnut'].includes(type)) {
                    return {
                        tooltip: {}, series: [{ type: 'pie', radius: type==='doughnut'?['40%','70%']:'55%', data: labels.map((l,i)=>({ name:l, value:data[i]||0 })) }]
                    };
                }
                return { title: { text: 'Chart' } };
            }

            buildApexOption(type, sample) {
                const { labels, datasets } = sample;
                const data = datasets[0]?.data || [];
                if (['bar','line','area'].includes(type)) {
                    return { chart: { type: type==='area'?'area':type }, series:[{ name: datasets[0]?.label||'Series', data }], xaxis:{ categories: labels } };
                }
                if (['pie','doughnut'].includes(type)) {
                    return { chart:{ type:'donut' }, labels, series: data };
                }
                return { chart:{ type:'line' }, series:[{ data }], xaxis:{ categories: labels } };
            }

            buildPlotlyPayload(type, sample) {
                const { labels, datasets } = sample;
                const data = datasets[0]?.data || [];
                if (['bar'].includes(type)) {
                    return { data:[{ type:'bar', x: labels, y: data }], layout:{ margin:{ t:20 } } };
                }
                if (['line','area'].includes(type)) {
                    return { data:[{ type:'scatter', mode:'lines', fill: type==='area'?'tozeroy':'none', x: labels, y: data }], layout:{ margin:{ t:20 } } };
                }
                if (['pie','doughnut'].includes(type)) {
                    return { data:[{ type:'pie', labels, values: data, hole: type==='doughnut'?0.5:0 }], layout:{ margin:{ t:20 } } };
                }
                return { data:[{ type:'scatter', x: labels, y: data }], layout:{ margin:{ t:20 } } };
            }

            showUpgradeModal() {
                if (document.getElementById('pro-overlay')) return;
                const overlay = document.createElement('div');
                overlay.id = 'pro-overlay';
                overlay.className = 'fixed inset-0 z-50 bg-black/70 flex items-center justify-center';
                const dialog = document.createElement('div');
                dialog.className = 'bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 text-center space-y-6';
                overlay.appendChild(dialog);

                const icon = document.createElement('div');
                icon.className = 'text-4xl';
                                dialog.appendChild(icon);

                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold text-slate-900';
                title.textContent = 'Unlock Pro Libraries';
                dialog.appendChild(title);

                const description = document.createElement('p');
                description.className = 'text-slate-600';
                description.textContent = 'Access Plotly, ApexCharts, advanced features, and unlimited generations.';
                dialog.appendChild(description);

                const actions = document.createElement('div');
                actions.className = 'space-y-3';
                dialog.appendChild(actions);

                const upgradeBtn = document.createElement('button');
                upgradeBtn.className = 'w-full px-4 py-3 bg-slate-900 text-white rounded-lg font-semibold hover:bg-slate-800 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500';
                upgradeBtn.dataset.action = 'upgrade-pro';
                upgradeBtn.textContent = 'Upgrade to Pro';
                actions.appendChild(upgradeBtn);

                const closeBtn = document.createElement('button');
                closeBtn.id = 'close-pro-overlay';
                closeBtn.className = 'w-full rounded-lg border border-slate-200 py-2 text-slate-700 hover:border-slate-300 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500';
                closeBtn.textContent = 'Not now';
                actions.appendChild(closeBtn);

                document.body.appendChild(overlay);
                closeBtn.addEventListener('click', ()=> overlay.remove());
                overlay.addEventListener('click', (e)=> { if (e.target===overlay) overlay.remove(); });
                this.bindUpgradeButtons(overlay);
            }

            renderChart(data) {
                const container = document.getElementById('chart-container');
                container.innerHTML = '';
                if (!data || !data.type) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'No chart configuration returned.';
                    container.appendChild(div);
                    return;
                }
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'Canvas is not supported in this environment.';
                    container.innerHTML = '';
                    container.appendChild(div);
                    return;
                }
                const ChartRef = (typeof Chart !== 'undefined') ? Chart : (typeof window !== 'undefined' ? window.Chart : undefined);
                if (!ChartRef) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'Chart library is still loading. Please wait a moment and try again.';
                    container.innerHTML = '';
                    container.appendChild(div);
                    return;
                }
                // Destroy previous chart if any
                if (this.currentChart && this.currentChart.destroy) {
                    try { this.currentChart.destroy(); } catch {}
                }
                // Create Chart.js instance from config
                this.currentChart = new ChartRef(ctx, data);
                this.maybeShowWatermark(container);
            }

            renderChartFromConfig(config) {
                const container = document.getElementById('chart-container');
                container.innerHTML = '';
                if (!config || !config.type) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'No chart configuration returned.';
                    container.appendChild(div);
                    return;
                }
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'Canvas is not supported in this environment.';
                    container.innerHTML = '';
                    container.appendChild(div);
                    return;
                }
                const ChartRef = (typeof Chart !== 'undefined') ? Chart : (typeof window !== 'undefined' ? window.Chart : undefined);
                if (!ChartRef) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'Chart library is still loading. Please wait a moment and try again.';
                    container.innerHTML = '';
                    container.appendChild(div);
                    return;
                }
                // Destroy previous chart if any
                if (this.currentChart && this.currentChart.destroy) {
                    try { this.currentChart.destroy(); } catch {}
                }
                // Create Chart.js instance from config
                this.currentChart = new ChartRef(ctx, config);
                this.maybeShowWatermark(container);
            }

            createChart(type, quotaResult) {
                const container = document.getElementById('chart-container');
                container.innerHTML = ''; // Clear previous chart

                if (quotaResult?.shouldShowAd) {
                    this.showAdOverlay();
                }

                // Create chart based on type
                if (['bar', 'line', 'pie', 'doughnut', 'area', 'scatter', 'bubble', 'radar', 'polar'].includes(type)) {
                    this.createChartJSChart(type);
                } else if (['force', 'treemap', 'sankey'].includes(type)) {
                    this.createD3Chart(type);
                }
            }

            async enforceQuota() {
                try {
                    const response = await fetch('/.netlify/functions/check-quota', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action: 'generate-chart' })
                    });

                    if (!response.ok) {
                        throw new Error('Quota check failed');
                    }

                    const result = await response.json();
                    this.updateQuotaBanner(result);

                    if (!result.allowed) {
                        const msg = result.message || 'Daily generation limit reached.';
                        try {
                            feedback.showToast(msg, 'warning');
                        } catch {
                            if (window.uiFeedback?.showToast) {
                                window.uiFeedback.showToast(msg, 'warning');
                            } else {
                                console.warn('[quota]', msg);
                            }
                        }
                        return result;
                    }

                    return result;
                } catch (error) {
                    console.warn('Quota check unavailable, proceeding without limits.', error);
                    return { allowed: true, shouldShowAd: false };
                }
            }

            updateQuotaBanner(result) {
                const banner = document.getElementById('quota-banner');
                const message = document.getElementById('quota-banner-message');
                const watchAdBtn = document.getElementById('watch-ad-btn');

                if (!banner || !message) return;

                if (result && result.bannerText) {
                    message.textContent = result.bannerText;
                } else {
                    message.textContent = `You have ${result?.remaining ?? 'unknown'} generations left today.`;
                }

                if (result && result.showBanner) {
                    banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                }

                if (watchAdBtn) {
                    watchAdBtn.disabled = !result?.canWatchAd;
                }
            }

            handleWatchAd() {
                this.showAdOverlay();
                document.dispatchEvent(new CustomEvent('billing:watchAd'));
            }

            bindUpgradeButtons(root = document) {
                const scope = root || document;
                scope.querySelectorAll('[data-action="upgrade-pro"]').forEach((btn) => {
                    if (btn.dataset.upgradeBound === 'true') return;
                    btn.dataset.upgradeBound = 'true';
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        document.dispatchEvent(new CustomEvent('billing:upgrade'));
                    });
                });
            }

            showAdOverlay() {
                if (document.getElementById('ad-overlay')) {
                    return;
                }

                const overlay = document.createElement('div');
                overlay.id = 'ad-overlay';
                overlay.className = 'fixed inset-0 z-50 bg-black/70 flex items-center justify-center';

                const dialog = document.createElement('div');
                dialog.className = 'bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-8 text-center space-y-6';
                overlay.appendChild(dialog);

                const icon = document.createElement('div');
                icon.className = 'text-4xl';
                                dialog.appendChild(icon);

                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold text-slate-900';
                title.textContent = 'Enjoy a quick break!';
                dialog.appendChild(title);

                const description = document.createElement('p');
                description.className = 'text-slate-600';
                description.textContent = 'A short ad is playing so you can unlock the next chart. Upgrade to Pro to remove ads and limits.';
                dialog.appendChild(description);

                const actions = document.createElement('div');
                actions.className = 'space-y-3';
                dialog.appendChild(actions);

                const upgradeBtn = document.createElement('button');
                upgradeBtn.className = 'w-full px-4 py-3 bg-slate-900 text-white rounded-lg font-semibold hover:bg-slate-800 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500';
                upgradeBtn.dataset.action = 'upgrade-pro';
                upgradeBtn.textContent = 'Upgrade to Pro';
                actions.appendChild(upgradeBtn);

                const closeBtn = document.createElement('button');
                closeBtn.id = 'close-ad-overlay';
                closeBtn.className = 'w-full rounded-lg border border-slate-200 py-2 text-slate-700 hover:border-slate-300 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500';
                closeBtn.textContent = 'Close';
                actions.appendChild(closeBtn);

                document.body.appendChild(overlay);
                closeBtn.addEventListener('click', () => {
                    overlay.remove();
                });

                overlay.addEventListener('click', (event) => {
                    if (event.target === overlay) {
                        overlay.remove();
                    }
                });

                this.bindUpgradeButtons(overlay);
            }

            createChartJSChart(type) {
                const container = document.getElementById('chart-container');
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);

                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'Canvas is not supported in this environment.';
                    container.innerHTML = '';
                    container.appendChild(div);
                    return;
                }

                const ChartRef = (typeof Chart !== 'undefined') ? Chart : (typeof window !== 'undefined' ? window.Chart : undefined);
                if (!ChartRef) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'Chart library is still loading. Please wait a moment and try again.';
                    container.innerHTML = '';
                    container.appendChild(div);
                    return;
                }

                const source = this.chartTypes || window.chartTypes;
                const sample = (source && typeof source.generateSampleData === 'function')
                    ? source.generateSampleData(type)
                    : { labels: ['A','B','C','D'], datasets: [{ label: 'Series', data: [12, 19, 3, 5] }] };

                const chartTypeMap = { area: 'line', polar: 'polarArea' };
                const chartType = chartTypeMap[type] || type;

                const config = {
                    type: chartType,
                    data: sample,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                };

                if (this.currentChart && this.currentChart.destroy) {
                    try { this.currentChart.destroy(); } catch {}
                }

                this.currentChart = new ChartRef(ctx, config);
                this.maybeShowWatermark(container);
            }

            createD3Chart(type) {
                const container = document.getElementById('chart-container');
                container.innerHTML = '';
                const div = document.createElement('div');
                div.className = 'text-slate-600';
                div.textContent = 'D3-based previews are not available in this environment yet. Please generate the chart using the main Generate button.';
                container.appendChild(div);
            }

            exportChart(format) {
                if (!this.currentChart) {
                    try {
                        feedback.showToast('Please generate a chart first', 'warning');
                    } catch {
                        if (window.uiFeedback?.showToast) {
                            window.uiFeedback.showToast('Please generate a chart first', 'warning');
                        } else {
                            console.warn('[export] Please generate a chart first');
                        }
                    }
                    return;
                }

                // Export based on format
                switch (format) {
                    case 'png':
                        this.exportAsPNG();
                        break;
                    case 'svg':
                        this.exportAsSVG();
                        break;
                    case 'pdf':
                        this.exportAsPDF();
                        break;
                    case 'html':
                        this.exportAsHTML();
                        break;
                }
            }

            async exportAsPNG() {
                if (!this.currentChart) {
                    try {
                        feedback.showToast('Please generate a chart first', 'warning');
                    } catch {
                        if (window.uiFeedback?.showToast) {
                            window.uiFeedback.showToast('Please generate a chart first', 'warning');
                        } else {
                            console.warn('[export] Please generate a chart first');
                        }
                    }
                    return;
                }

                try {
                    const chartInstance = this.currentChart;
                    const filename = 'vizom-chart.png';

                    if (chartInstance && typeof chartInstance.toBase64Image === 'function') {
                        await chartExporter.exportPNG(chartInstance, filename);
                    } else {
                        const container = document.getElementById('chart-container');
                        if (!container) {
                            throw new Error('Chart container not found');
                        }
                        await chartExporter.exportPNG(container, filename);
                    }

                    try { trackEvent('chart_exported', { format: 'png' }); } catch {}
                } catch (error) {
                    try { ErrorTracker.trackError(error, { context: 'png-export' }); } catch {}
                    const msg = 'Failed to export PNG. Please try again.';
                    try {
                        feedback.showToast(msg, 'error');
                    } catch {
                        if (window.uiFeedback?.showToast) {
                            window.uiFeedback.showToast(msg, 'error');
                        } else {
                            console.error('[export]', msg, error);
                        }
                    }
                }
            }

            async exportAsSVG() {
                if (!this.currentChart) {
                    try {
                        feedback.showToast('Please generate a chart first', 'warning');
                    } catch {
                        if (window.uiFeedback?.showToast) {
                            window.uiFeedback.showToast('Please generate a chart first', 'warning');
                        } else {
                            console.warn('[export] Please generate a chart first');
                        }
                    }
                    return;
                }

                try {
                    const chart = this.currentChart;
                    const filename = 'vizom-chart.svg';

                    if (chart && typeof chart.toBase64Image === 'function') {
                        await chartExporter.exportSVG(chart, filename);
                    } else if (chart && chart.svg && typeof chart.svg.node === 'function') {
                        const svgData = chart.svg.node().outerHTML;
                        const blob = new Blob([svgData], { type: 'image/svg+xml' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);
                    } else {
                        const container = document.getElementById('chart-container');
                        if (!container) {
                            throw new Error('Chart container not found');
                        }
                        await chartExporter.exportSVG(container, filename);
                    }

                    try { trackEvent('chart_exported', { format: 'svg' }); } catch {}
                } catch (error) {
                    try { ErrorTracker.trackError(error, { context: 'svg-export' }); } catch {}
                    const msg = 'Failed to export SVG. Please try again.';
                    try {
                        feedback.showToast(msg, 'error');
                    } catch {
                        if (window.uiFeedback?.showToast) {
                            window.uiFeedback.showToast(msg, 'error');
                        } else {
                            console.error('[export]', msg, error);
                        }
                    }
                }
            }

            async exportAsPDF() {
                const container = document.getElementById('chart-container');
                const qualitySel = document.getElementById('pdf-quality');
                const scale = qualitySel ? Number(qualitySel.value) : 1;

                if (!container) {
                    const msg = 'Chart container not found';
                    try {
                        feedback.showToast(msg, 'error');
                    } catch {
                        if (window.uiFeedback?.showToast) {
                            window.uiFeedback.showToast(msg, 'error');
                        } else {
                            console.error('[export]', msg);
                        }
                    }
                    return;
                }

                try {
                    await exportChartToPDF(container, {
                        filename: 'vizom-chart.pdf',
                        orientation: 'landscape',
                        quality: 0.95,
                        scale
                    });
                    try { trackEvent('chart_exported', { format: 'pdf' }); } catch {}
                } catch (error) {
                    try { ErrorTracker.trackError(error, { context: 'pdf-export' }); } catch {}
                    const msg = 'Failed to export PDF. Please try again.';
                    try {
                        feedback.showToast(msg, 'error');
                    } catch {
                        if (window.uiFeedback?.showToast) {
                            window.uiFeedback.showToast(msg, 'error');
                        } else {
                            console.error('[export]', msg, error);
                        }
                    }
                }
            }

            exportAsHTML() {
                const htmlContent = this.generateHTMLCode();
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = 'chart.html';
                link.href = url;
                link.click();
                try { trackEvent('chart_exported', { format: 'html' }); } catch {}
            }

            generateHTMLCode() {
                return `
<!DOCTYPE html>
<html>
<head>
    <title>Generated Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>
<\/head>
<body>
    <canvas id="chart" width="400" height="300"><\/canvas>
    <script>
        // Chart code would go here
    <\/script>
<\/body>
<\/html>`;
            }

            refreshPreview() {
                if (this.currentChartType) {
                    this.createChart(this.currentChartType);
                }
            }

            toggleFullscreen() {
                const container = document.getElementById('chart-container');
                if (!document.fullscreenElement) {
                    container.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            showLoading() {
                const prompt = document.getElementById('prompt-input')?.value || '';
                feedback.showLoading('AI Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð²Ð°Ñˆ Ð·Ð°Ð¿Ñ€Ð¾Ñ', 'Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ñ‹');
                progressLoading.showLoading('chart-generation', {
                    title: 'AI is generating your chart',
                    description: prompt ? `Creating visuals for: ${prompt.slice(0, 60)}${prompt.length > 60 ? 'â€¦' : ''}` : 'This usually takes 5-10 seconds',
                    animation: 'chart',
                    friendlyMessages: [
                        "Analyzing your data patterns...",
                        "Finding the perfect visualization...",
                        "Creating beautiful charts...",
                        "Almost ready..."
                    ]
                });
                return { hide: () => this.hideLoading() };
            }

            hideLoading() {
                feedback.hideLoading();
                progressLoading.hideLoading('chart-generation');
            }

            showSuccess() {
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4';
                successMsg.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle"></i>
                        <span>Chart generated successfully!</span>
                    </div>
                `;
                
                const container = document.getElementById('chart-container');
                const existingMsg = container.querySelector('.success-message');
                if(existingMsg) existingMsg.remove();

                container.insertBefore(successMsg, container.firstChild);
                setTimeout(() => successMsg.remove(), 3000);
                feedback.showToast('Chart generated successfully!', 'success');
            }

            handleError(error) {
                console.error('Chart generation error:', error);
                this.clearPromptFormatError();
                
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4';
                errorMsg.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Failed to generate chart: ${error.message || 'Unknown error'}</span>
                    </div>
                `;
                
                const container = document.getElementById('chart-container');
                // Clear previous content and show error
                container.innerHTML = '';
                container.appendChild(errorMsg);
                feedback.showToast(error.message || 'Generation failed', 'error');
            }

            showPromptFormatHelp(message) {
                const helperText = document.getElementById('prompt-helper');
                if (helperText) {
                    helperText.textContent = message || helperText.dataset.defaultText || 'Describe your chart in plain English';
                    helperText.classList.add('text-red-600');
                    helperText.classList.remove('text-gray-600');
                }

                const hint = document.getElementById('prompt-format-hint');
                if (hint) {
                    hint.classList.add('text-red-600');
                    hint.classList.remove('text-slate-500');
                }
            }

            clearPromptFormatError() {
                const helperText = document.getElementById('prompt-helper');
                if (helperText) {
                    const defaultText = helperText.dataset.defaultText || 'Describe your chart in plain English';
                    helperText.textContent = defaultText;
                    helperText.classList.remove('text-red-600');
                    helperText.classList.add('text-gray-600');
                }

                const hint = document.getElementById('prompt-format-hint');
                if (hint) {
                    hint.classList.remove('text-red-600');
                    hint.classList.add('text-slate-500');
                }
            }

            highlightPromptInput() {
                const promptInput = document.getElementById('prompt-input');
                if (!promptInput) return;
                promptInput.classList.add('invalid', 'prompt-error-shake');
                setTimeout(() => promptInput.classList.remove('prompt-error-shake'), 400);
            }

            isPromptFormatError(error) {
                return error?.code === 'invalid_prompt_format' || error?.code === 'invalid_json_prompt';
            }
        }

        // Initialize the generator when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new ChartGenerator();

            // Prefill prompt from URL param and show tooltip
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const promptFromUrl = urlParams.get('prompt');
                if (promptFromUrl) {
                    const promptInput = document.getElementById('prompt-input');
                    if (promptInput) {
                        promptInput.value = promptFromUrl;
                        // Track prefill source
                        try { trackEvent('generator_prefilled', { source: 'landing' }); } catch {}
                        // Inject tooltip and animation
                        showTooltip();
                        try { updateButtonState(); } catch {}
                    }
                }
            } catch {}

            // Track export attempts pre-action
            try {
                document.querySelectorAll('.export-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const fmt = btn.dataset.format || 'unknown';
                        try { trackEvent('export_attempt', { format: fmt }); } catch {}
                    });
                });
            } catch {}

            // ===== Prompt validation & button disable =====
            try {
                const vStyleId = 'vizom-prompt-validation';
                if (!document.getElementById(vStyleId)) {
                    const st = document.createElement('style');
                    st.id = vStyleId;
                    st.textContent = `#prompt-input.invalid{border-color:#EF4444} #prompt-input.valid{border-color:#10B981} #generate-chart:disabled{opacity:.5;cursor:not-allowed}`;
                    document.head.appendChild(st);
                }

                const promptInput = document.getElementById('prompt-input');
                const generateBtn = document.getElementById('generate-chart');
                const helperText = document.getElementById('prompt-helper');

                function updateButtonState() {
                    const value = String(promptInput?.value || '').trim();
                    const isValid = value.length >= 3 && value.length <= 500;
                    if (generateBtn) generateBtn.disabled = !isValid;

                    if (promptInput) {
                        promptInput.classList.toggle('invalid', !isValid && value.length > 0);
                        promptInput.classList.toggle('valid', isValid);
                    }

                    if (helperText) {
                        if (isValid) {
                            helperText.textContent = 'Press Enter or click Generate';
                            helperText.classList.remove('text-red-600');
                            helperText.classList.add('text-gray-600');
                        } else {
                            if (value.length === 0) {
                                helperText.textContent = 'Describe your chart in plain English';
                                helperText.classList.remove('text-red-600');
                                helperText.classList.add('text-gray-600');
                            } else if (value.length < 3) {
                                helperText.textContent = 'Please enter at least 3 characters';
                                helperText.classList.add('text-red-600');
                                helperText.classList.remove('text-gray-600');
                            } else if (value.length > 500) {
                                helperText.textContent = 'Prompt is too long (max 500 characters)';
                                helperText.classList.add('text-red-600');
                                helperText.classList.remove('text-gray-600');
                            }
                        }
                    }
                }

                function validatePrompt() {
                    const value = String(promptInput?.value || '').trim();
                    if (!helperText) return;
                    if (value.length === 0) {
                        helperText.textContent = 'Describe your chart in plain English';
                        helperText.classList.remove('text-red-600');
                        helperText.classList.add('text-gray-600');
                    } else if (value.length < 3) {
                        helperText.textContent = 'Please be more specific (min 3 characters)';
                        helperText.classList.add('text-red-600');
                        helperText.classList.remove('text-gray-600');
                    } else if (value.length > 500) {
                        helperText.textContent = 'Prompt is too long (max 500 characters)';
                        helperText.classList.add('text-red-600');
                        helperText.classList.remove('text-gray-600');
                    } else {
                        helperText.textContent = `${500 - value.length} characters remaining`;
                        helperText.classList.remove('text-red-600');
                        helperText.classList.add('text-gray-600');
                    }
                }

                if (promptInput) {
                    promptInput.addEventListener('input', updateButtonState);
                    promptInput.addEventListener('blur', validatePrompt);
                }
                if (generateBtn) {
                    generateBtn.addEventListener('click', (e) => {
                        const value = String(promptInput?.value || '').trim();
                        if (value.length < 3) {
                            e.preventDefault();
                            promptInput?.focus();
                            if (helperText) {
                                helperText.textContent = 'Please enter a chart description';
                                helperText.classList.add('text-red-600');
                                helperText.classList.remove('text-gray-600');
                            }
                        }
                    });
                }

                // Initial state
                updateButtonState();
            } catch {}
        });

        function showTooltip() {
            const existing = document.getElementById('vizom-prefill-tip');
            if (existing) existing.remove();
            // Ensure animation keyframes exist
            const styleId = 'vizom-tooltip-anim';
            if (!document.getElementById(styleId)) {
                const st = document.createElement('style');
                st.id = styleId;
                st.textContent = `@keyframes viz-bounce {0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-10px)}} .viz-animate-bounce{animation:viz-bounce 1s ease-in-out 3}`;
                document.head.appendChild(st);
            }
            const tip = document.createElement('div');
            tip.id = 'vizom-prefill-tip';
            tip.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 viz-animate-bounce';
                        tip.textContent = 'Click "Generate" to create your chart!';
            document.body.appendChild(tip);
            setTimeout(() => {
                tip.style.transition = 'opacity .3s ease';
                tip.style.opacity = '0';
                setTimeout(() => tip.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>

  <!-- Projects Modal -->
  <div id="projects-modal" class="modal hidden modal-fade" role="dialog" aria-modal="true" aria-labelledby="projects-title">
    <div class="modal-content bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b border-slate-200" id="projects-modal-title">
        <h3 class="text-xl font-semibold text-slate-900">ÐœÐ¾Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹</h3>
        <button id="close-projects-modal" class="text-slate-400 hover:text-slate-600 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" aria-label="Close projects modal">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6 overflow-y-auto max-h-[60vh]">
        <div id="projects-list" class="grid gap-4">
          <!-- Projects will be dynamically loaded here -->
        </div>
        <div id="no-projects" class="hidden text-center py-12">
          <i class="fas fa-folder-open text-4xl text-slate-300 mb-4"></i>
          <p class="text-slate-500">Ð£ Ð²Ð°Ñ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð²</p>
          <p class="text-sm text-slate-400 mt-2">Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ ÑÐ²Ð¾Ð¹ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ ÐµÐ³Ð¾</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Project Modal -->
  <div id="save-project-modal" class="modal hidden modal-fade" role="dialog" aria-modal="true" aria-labelledby="save-project-title">
    <div class="modal-content bg-white rounded-2xl shadow-xl max-w-md w-full p-6 space-y-4">
      <div class="flex items-center justify-between" id="save-project-modal-title">
        <h3 class="text-xl font-semibold text-slate-900" id="save-project-modal-description">Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚</h3>
        <button id="close-save-modal" class="text-slate-400 hover:text-slate-600 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" aria-label="Close save project modal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium text-slate-700" id="project-title-label">Project Title</label>
        <input type="text" id="project-title" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="ÐœÐ¾Ð¸ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸ Q1 2024" aria-labelledby="project-title-label" aria-describedby="project-title-description">
        <p id="project-title-description" class="text-sm text-slate-400">Enter a title for your project</p>
      </div>
      <div class="flex gap-3">
        <button id="confirm-save-project" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" aria-label="Confirm save project">
          Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ
        </button>
        <button id="cancel-save-project" class="flex-1 border border-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:border-slate-300 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" aria-label="Cancel save project">
          ÐžÑ‚Ð¼ÐµÐ½Ð°
        </button>
      </div>
    </div>
  </div>

  </main>

  <!-- Unified Footer -->
  <footer id="unified-footer">
    <!-- Footer content will be dynamically loaded by UnifiedFooter.js -->
  </footer>

  <!-- /* LEGACY/IGNORE: for demo only */ footer.css was previously used by a dynamic footer; Tailwind footers are inline on key pages -->
  <!-- <link rel="stylesheet" href="src/styles/components/footer.css"> -->

  <!-- ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    
  <script>
    // Enhanced loading functions using the LoadingStatesManager
    function showLoading(id = 'chart-generation', config = {}) {
      if (window.loadingStates) {
        const defaultConfig = {
          title: 'AI is generating your chart',
          description: 'This usually takes 5-10 seconds',
          progressBar: true,
          steps: true,
          stepTexts: [
            { text: 'Processing your input', threshold: 30 },
            { text: 'Generating visualization', threshold: 70 },
            { text: 'Finalizing chart', threshold: 100 }
          ],
          showCancel: true,
          timeout: 30000
        };
        
        return window.loadingStates.showLoading(id, { ...defaultConfig, ...config });
      } else {
        // Fallback to basic loading
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.remove('hidden');
          return { hide: () => overlay.classList.add('hidden') };
        }
      }
    }

    function hideLoading(id = 'chart-generation') {
      if (window.loadingStates) {
        return window.loadingStates.hideLoading(id);
      } else {
        // Fallback to basic loading
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.add('hidden');
        }
        return true;
      }
    }

    function updateProgress(id, progress, text) {
      if (window.loadingStates) {
        return window.loadingStates.updateProgress(id, progress, text);
      }
      return false;
    }

    // Example usage with Smart Parse button
    document.addEventListener('DOMContentLoaded', () => {
      const smartParseBtn = document.getElementById('smart-parse-btn');
      
      if (smartParseBtn) {
        smartParseBtn.addEventListener('click', () => {
          // Check if input is ready for generation
          const isReady = window.inputValidation?.isReadyForGeneration('prompt-input');
          
          if (!isReady) {
            // Show validation feedback instead of loading
            const feedback = document.getElementById('input-feedback');
            if (feedback && feedback.classList.contains('hidden')) {
              window.inputValidation?.validate('prompt-input', 'input-feedback');
            }
            return;
          }
          
          // Show enhanced loading
          const loader = showLoading('chart-generation', {
            title: 'AI is generating your chart',
            description: 'Analyzing your data and creating the perfect visualization...',
            steps: true,
            progressBar: true
          });
          
          // Simulate progress updates
          let progress = 0;
          const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            
            if (progress < 30) {
              updateProgress('chart-generation', progress, 'Processing your input...');
            } else if (progress < 70) {
              updateProgress('chart-generation', progress, 'Generating visualization...');
            } else if (progress < 100) {
              updateProgress('chart-generation', progress, 'Finalizing chart...');
            } else {
              progress = 100;
              updateProgress('chart-generation', progress, 'Complete!');
              clearInterval(progressInterval);
              
              // Hide loading after completion
              setTimeout(() => {
                hideLoading('chart-generation');
              }, 1000);
            }
          }, 300);
          
          // Simulate completion after 5 seconds
          setTimeout(() => {
            clearInterval(progressInterval);
            updateProgress('chart-generation', 100, 'Chart generated successfully!');
            setTimeout(() => {
              hideLoading('chart-generation');
            }, 1000);
          }, 5000);
        });
      }

      // Listen for validation events
      document.addEventListener('input:validated', (e) => {
        const { validation } = e.detail;
        
        // Enable/disable smart parse button based on validation
        const smartParseBtn = document.getElementById('smart-parse-btn');
        if (smartParseBtn) {
          if (validation.isValid && validation.score >= 70) {
            smartParseBtn.disabled = false;
            smartParseBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          } else {
            smartParseBtn.disabled = true;
            smartParseBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        }
      });

      // Example with file upload
      const csvUpload = document.getElementById('csv-upload');
      if (csvUpload) {
        csvUpload.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            const loader = showLoading('file-upload', {
              title: 'Processing your file',
              description: 'Analyzing CSV data and preparing for visualization...',
              progressBar: true,
              steps: false
            });
            
            // Simulate file processing
            setTimeout(() => {
              hideLoading('file-upload');
            }, 3000);
          }
        });
      }

      // Example with project save
      const saveProjectBtn = document.getElementById('save-project');
      if (saveProjectBtn) {
        saveProjectBtn.addEventListener('click', () => {
          const buttonLoader = window.loadingStates?.showButtonLoading(saveProjectBtn, 'Saving...');
          
          setTimeout(() => {
            if (buttonLoader) {
              buttonLoader.hide();
            }
          }, 2000);
        });
      }

      // Clear input functionality
      const clearBtn = document.getElementById('clear-input');
      const textarea = document.getElementById('prompt-input');
      
      if (clearBtn && textarea) {
        clearBtn.addEventListener('click', () => {
          textarea.value = '';
          window.inputValidation?.validate('prompt-input', 'input-feedback');
          window.inputValidation?.updateCharCount(textarea, 'char-count');
          textarea.focus();
        });
      }
    });

    // Global error handling for loading timeouts
    window.addEventListener('error', (e) => {
      // Hide any active loading states on error
      if (window.loadingStates) {
        const activeLoaders = window.loadingStates.getActiveLoaders();
        activeLoaders.forEach(id => {
          window.loadingStates.hideLoading(id);
        });
      }
    });
  </script>

  <script type="module" src="/src/components/mobile-menu.js"></script>
</body>
</html>
