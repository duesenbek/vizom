<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIZOM - AI Chart Generator</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="public/images/vizom-icon.png">
    <link rel="apple-touch-icon" href="public/images/vizom-icon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="src/styles/font-awesome.min.css" />
    
    <!-- Modern Styles -->
    <link rel="stylesheet" href="src/styles/modern-saas.css" />
    <link rel="stylesheet" href="src/styles/components/improvements.css" />
    <link rel="stylesheet" href="src/styles/components/responsive-fixes.css" />
    <link rel="stylesheet" href="src/styles/ui-guidelines.css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <!-- D3.js global bridge -->
    <script type="module">
        import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';
        if (typeof window !== 'undefined') {
            window.d3 = d3;
        }
    </script>

    <!-- Supabase client -->
    <script type="module" src="src/supabase-client.js"></script>

    <!-- Supabase auth and payment handlers -->
    <script type="module" src="src/supabase-auth.js"></script>
    <script type="module" src="src/payments/stripe-client.js"></script>
    <style>
    /* Three-Panel Layout Styles */
    .generator-layout {
      display: flex;
      height: calc(100vh - 64px);
      overflow: hidden;
    }

    /* Left Sidebar Styles */
    .left-sidebar {
      width: 320px;
      background: white;
      border-right: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chart-type-card {
      transition: all 0.2s ease;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      max-width: 20rem; /* 320px */
      min-height: 15rem; /* 240px */
      aspect-ratio: 16 / 10;
      padding: 16px;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }

    .chart-type-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    /* Card preview area */
    .chart-type-card .preview-image,
    .chart-type-card .preview,
    .chart-type-card img {
      width: 100%;
      height: 8rem; /* 128px */
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 1rem;
      background: #f8fafc;
    }

    /* Titles and descriptions with clamps */
    .chart-type-card h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: -webkit-box;
      display: box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      box-orient: vertical;
      overflow: hidden;
    }

    .chart-type-card .description,
    .chart-type-card p {
      color: #64748b;
      display: -webkit-box;
      display: box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      box-orient: vertical;
      overflow: hidden;
    }

    /* Buttons WCAG size */
    .generator-layout button,
    .left-sidebar button,
    .center-panel button,
    .right-sidebar button {
      min-height: 44px;
    }

    .chart-type-card.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    /* Tab Navigation Styles */
    .tab-nav {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: #f1f5f9;
      border-radius: 8px;
    }

    .tab-button {
      flex: 1;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      transition: all 0.2s ease;
      background: transparent;
      border: none;
      color: #64748b;
      cursor: pointer;
    }

    .tab-button.active {
      background: white;
      color: #3b82f6;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Center Panel Styles */
    .center-panel {
      flex: 1;
      background: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .workspace-header {
      padding: 24px 32px;
      border-bottom: 1px solid #e2e8f0;
    }

    .workspace-content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }

    /* Textarea Styles */
    .prompt-textarea {
      width: 100%;
      height: 256px;
      padding: 24px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      line-height: 1.6;
      resize: none;
      transition: all 0.2s ease;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .prompt-textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    /* Quick Action Buttons */
    .quick-action-btn {
      padding: 8px 16px;
      background: #f1f5f9;
      color: #475569;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .quick-action-btn:hover {
      background: #e2e8f0;
      transform: translateY(-1px);
    }

    /* Generate Button */
    .generate-btn {
      width: 100%;
      padding: 16px;
      background: #3b82f6;
      color: white;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .generate-btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .generate-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Right Sidebar Styles */
    .right-sidebar {
      width: 384px;
      background: white;
      border-left: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-container {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    .chart-preview {
      border: 2px dashed #e2e8f0;
      border-radius: 12px;
      height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8fafc;
      transition: all 0.2s ease;
    }

    .chart-preview.has-chart {
      border-style: solid;
      border-color: #3b82f6;
      background: white;
    }

    .preview-placeholder {
      text-align: center;
      color: #64748b;
    }

    /* Export Controls */
    .export-controls {
      padding: 24px;
      border-top: 1px solid #e2e8f0;
    }

    .export-section {
      position: relative;
    }

    .export-buttons {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .export-main-btn {
      position: relative;
    }

    .export-menu {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 50;
    }

    .format-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .format-btn {
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      background: white;
      color: #475569;
      cursor: pointer;
    }

    .format-btn:hover {
      background: #f1f5f9;
      border-color: #3b82f6;
    }

    .format-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .download-section {
      display: flex;
      gap: 8px;
    }

    .download-btn {
      flex: 1;
      padding: 12px;
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .download-btn:hover {
      background: #2563eb;
    }

    .download-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .share-btn {
      padding: 12px;
      background: white;
      color: #475569;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .share-btn:hover {
      background: #f1f5f9;
      border-color: #3b82f6;
    }

    .share-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Project Management */
    .project-controls {
      padding: 24px;
      border-top: 1px solid #e2e8f0;
    }

    .project-btn {
      width: 100%;
      padding: 12px;
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .project-btn:hover {
      background: #e2e8f0;
      border-color: #3b82f6;
    }

    .project-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .project-btn:last-child {
      margin-bottom: 0;
    }

    .project-btn.primary {
      background: white;
    }

    /* Settings Panel */
    .settings-panel {
      border-top: 1px solid #e2e8f0;
    }

    .settings-toggle {
      width: 100%;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .settings-toggle:hover {
      background: #f8fafc;
    }

    .settings-content {
      padding: 16px 24px;
      border-top: 1px solid #e2e8f0;
    }

    .setting-group {
      margin-bottom: 16px;
    }

    .setting-group:last-child {
      margin-bottom: 0;
    }

    .setting-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #334155;
      margin-bottom: 8px;
    }

    .setting-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: #334155;
    }

    .setting-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #e2e8f0;
      border-radius: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .toggle-switch.active {
      background: #3b82f6;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    /* Enhanced Loading States */
    .progress-loading-overlay {
      --primary-color: #1872D9;
      --success-color: #10B981;
      --error-color: #EF4444;
      --text-primary: #003466;
      --text-secondary: #123472;
    }

    .progress-loading-card {
      border: 1px solid rgba(0, 52, 102, 0.1);
      box-shadow: 0 20px 25px -5px rgba(0, 52, 102, 0.1), 0 10px 10px -5px rgba(0, 52, 102, 0.04);
    }

    .error-action-btn {
      transition: all 0.2s ease;
    }

    .error-action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 52, 102, 0.15);
    }

    .copy-prompt-btn, .edit-prompt-btn {
      transition: all 0.2s ease;
    }

    .copy-prompt-btn:hover, .edit-prompt-btn:hover {
      transform: translateX(2px);
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
      .progress-loading-card {
        margin: 0.5rem;
        padding: 1rem;
        max-width: calc(100vw - 1rem);
      }
      
      .step-indicator {
        transform: scale(0.8);
      }
      
      .error-action-btn {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
      }
    }

    /* Enhanced animations */
    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .progress-loading-overlay.active {
      animation: slideInUp 0.3s ease-out;
    }

    /* Chart animation enhancements */
    .chart-animation svg {
      filter: drop-shadow(0 2px 4px rgba(24, 114, 217, 0.2));
    }

    /* Success/error state transitions */
    .success-message, .error-message {
      animation: slideInDown 0.3s ease-out;
    }

    @keyframes slideInDown {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Loading States */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .loading-spinner {
      margin-bottom: 16px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-container {
      margin: 16px 0;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: #3b82f6;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: #64748b;
    }

    .loading-steps {
      text-align: left;
      margin-top: 16px;
    }

    .step {
      padding: 4px 0;
      font-size: 14px;
      color: #64748b;
      transition: all 0.2s ease;
      position: relative;
      padding-left: 20px;
    }

    .step::before {
      content: "‚óã";
      position: absolute;
      left: 0;
      font-size: 12px;
    }

    .step.active {
      color: #3b82f6;
      font-weight: 500;
    }

    .step.active::before {
      content: "‚óè";
      color: #3b82f6;
    }

    .step.completed {
      color: #10b981;
    }

    .step.completed::before {
      content: "‚úì";
      color: #10b981;
    }

    /* Responsive Design */
    @media (max-width: 1023px) {
      .generator-layout {
        flex-direction: column;
      }

      .left-sidebar,
      .right-sidebar {
        width: 100%;
        height: auto;
        border: none;
        border-bottom: 1px solid #e2e8f0;
      }

      .center-panel {
        flex: 1;
        min-height: 400px;
      }
    }

    @media (max-width: 767px) {
      .workspace-content {
        padding: 16px;
      }

      .prompt-textarea {
        height: 200px;
        padding: 16px;
        font-size: 14px;
      }

      .format-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .quick-action-btn {
        font-size: 12px;
        padding: 6px 12px;
      }
    }

    /* Scrollbar Styling */
    .scrollbar-thin {
      scrollbar-width: thin;
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Validation Feedback */
    .input-feedback {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .input-feedback.valid {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .input-feedback.invalid {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .input-feedback.warning {
      background: #fef3c7;
      color: #d97706;
      border: 1px solid #fde68a;
    }

    .feedback-icon {
      font-size: 16px;
    }

    .feedback-text {
      flex: 1;
    }
  </style>
</head>
<body class="bg-white">
    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="ui-container">
            <nav class="flex items-center justify-between h-16">
                <a href="index.html" class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-simple text-white"></i>
                    </div>
                    <span class="text-xl font-bold text-slate-900">VIZOM</span>
                </a>
                <button class="md:hidden ui-btn ui-btn-ghost" id="mobile-menu-toggle" aria-label="Toggle menu">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="hidden md:flex items-center gap-8" id="nav-links">
                    <a href="index.html" class="ui-body font-medium text-slate-600 hover:text-slate-900 transition">Home</a>
                    <a href="generator.html" class="ui-body font-medium text-blue-600">Generator</a>
                    <a href="templates.html" class="ui-body font-medium text-slate-600 hover:text-slate-900 transition">Templates</a>
                    <a href="pricing.html" class="ui-body font-medium text-slate-600 hover:text-slate-900 transition">Pricing</a>
                    <button class="ui-btn ui-btn-ghost" id="auth-signin" type="button">Sign In</button>
                    <a href="generator.html" class="ui-btn ui-btn-primary" data-action="get-started">Get Started</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Generator -->
    <div class="container">
        <div class="generator-layout">
            <!-- Left: Chart Picker -->
            <aside class="chart-picker">
                <h3 class="section-title">Chart Type</h3>
                <div class="chart-options">
                    <div class="chart-option selected" data-type="bar">
                        <div class="chart-preview">üìä</div>
                        <span class="chart-name">Bar Chart</span>
                    </div>
                    <div class="chart-option" data-type="line">
                        <div class="chart-preview">üìà</div>
                        <span class="chart-name">Line Chart</span>
                    </div>
                    <div class="chart-option" data-type="pie">
                        <div class="chart-preview">üü£</div>
                        <span class="chart-name">Pie Chart</span>
                    </div>
                    <div class="chart-option" data-type="doughnut">
                        <div class="chart-preview">‚≠ï</div>
                        <span class="chart-name">Doughnut</span>
                    </div>
                    <div class="chart-option" data-type="area">
                        <div class="chart-preview">üìâ</div>
                        <span class="chart-name">Area Chart</span>
                    </div>
                    <div class="chart-option" data-type="scatter">
                        <div class="chart-preview">‚ö°</div>
                        <span class="chart-name">Scatter Plot</span>
                    </div>
                    <div class="chart-option" data-type="bubble">
                        <div class="chart-preview">ü´ß</div>
                        <span class="chart-name">Bubble Chart</span>
                    </div>
                    <div class="chart-option" data-type="radar">
                        <div class="chart-preview">üéØ</div>
                        <span class="chart-name">Radar Chart</span>
                    </div>
                    <div class="chart-option" data-type="polar">
                        <div class="chart-preview">üåê</div>
                        <span class="chart-name">Polar Area</span>
                    </div>
                    <div class="chart-option" data-type="force">
                        <div class="chart-preview">üï∏Ô∏è</div>
                        <span class="chart-name">Force Graph</span>
                    </div>
                    <div class="chart-option" data-type="treemap">
                        <div class="chart-preview">üóÇÔ∏è</div>
                        <span class="chart-name">TreeMap</span>
                    </div>
                    <div class="chart-option" data-type="sankey">
                        <div class="chart-preview">üåä</div>
                        <span class="chart-name">Sankey</span>
                    </div>
                </div>
            </aside>

            <!-- Center: Input Panel -->
            <main class="input-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Describe Your Chart</h2>
                    <p class="panel-subtitle">Tell AI what kind of chart you want to create</p>
                </div>

                <div class="panel-content">
                    <!-- Prompt Input -->
                    <div class="input-group">
                        <label class="input-label">Chart Description</label>
                        <textarea 
                            id="prompt-input"
                            data-testid="prompt-input"
                            class="prompt-textarea"
                            placeholder="Example: Create a bar chart showing monthly sales data for Q1 2024 with products A, B, and C. Use blue colors and add a trend line."
                        ></textarea>
                        <p id="prompt-helper" class="text-sm text-gray-600 mt-2">Describe your chart in plain English</p>
                    </div>

                    <!-- Library Selector -->
                    <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="flex items-center gap-3">
                            <label for="chart-library" class="text-sm font-medium text-slate-700">Chart Library</label>
                            <select id="chart-library" class="border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                <option value="auto">Auto</option>
                                <option value="chartjs">Chart.js (Free)</option>
                                <option value="echarts">ECharts (Basic Free)</option>
                                <option value="apexcharts" data-pro-only>APEXCharts (PRO)</option>
                                <option value="plotly" data-pro-only>Plotly (PRO)</option>
                            </select>
                        </div>
                        <div class="text-xs text-slate-500">
                            <span class="ui-badge ui-badge-light">PRO</span> libraries unlock advanced visuals and exports.
                            <button class="ui-btn ui-btn-link text-blue-600" data-action="upgrade-pro">Upgrade</button>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button id="generate-chart" class="generate-btn" data-testid="generate-button">
                        <i class="fas fa-magic"></i>
                        <span>Generate Chart</span>
                    </button>

                    <!-- Quick Prompts -->
                    <div class="quick-prompts">
                        <h4 class="quick-title">Quick Prompts</h4>
                        <div class="prompt-suggestions">
                            <button class="prompt-btn" data-prompt="Create a pie chart showing market share percentages for tech companies" data-type="pie">
                                üìä Market Share Pie
                            </button>
                            <button class="prompt-btn" data-prompt="Generate a line chart showing temperature trends over 12 months" data-type="line">
                                üìà Temperature Trends
                            </button>
                            <button class="prompt-btn" data-prompt="Build a bar chart comparing sales performance across 4 quarters" data-type="bar">
                                üìâ Sales Comparison
                            </button>
                            <button class="prompt-btn" data-prompt="Create a scatter plot showing correlation between age and income" data-type="scatter">
                                ‚ö° Correlation Plot
                            </button>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right: Preview Panel -->
            <aside class="preview-panel">
                <div class="panel-header">
                    <h2 class="panel-title">Live Preview</h2>
                    <div class="preview-actions">
                        <button id="refresh-preview" class="action-btn" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="fullscreen-preview" class="action-btn" title="Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>

                <div class="panel-content">
                    <!-- Chart Display -->
                    <div class="chart-display">
                        <div id="chart-container" class="chart-container" data-testid="chart-container">
                            <div class="empty-state">
                                <i class="fas fa-chart-line empty-icon"></i>
                                <p class="empty-text">Your chart will appear here</p>
                                <p class="empty-subtext">Describe your chart and click Generate</p>
                            </div>
                        </div>
                        <div id="generation-error" data-testid="error-message" class="hidden text-red-600 text-sm mt-2"></div>
                    </div>

                    <!-- Export Options -->
                    <div class="export-section export-options">
                        <h4 class="export-title">Export Options</h4>
                        <div class="export-buttons">
                            <button class="export-main-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2" data-testid="export-main-button">
                                <i class="fas fa-download"></i>
                                <span>Export Chart</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div class="export-menu hidden absolute top-full left-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-lg z-50 min-w-[160px]">
                                <button class="export-option w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-3" data-format="png">
                                    <i class="fas fa-image text-gray-600"></i>
                                    <span>PNG Image</span>
                                </button>
                                <button class="export-option w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-3" data-format="svg">
                                    <i class="fas fa-vector-square text-gray-600"></i>
                                    <span>SVG Vector</span>
                                </button>
                                <button class="export-option w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-3" data-format="csv">
                                    <i class="fas fa-table text-gray-600"></i>
                                    <span>CSV Data</span>
                                </button>
                                <button class="export-option w-full text-left px-4 py-2 hover:bg-gray-50 flex items-center gap-3" data-format="pdf">
                                    <i class="fas fa-file-pdf text-gray-600"></i>
                                    <span>PDF Document</span>
                                </button>
                            </div>
                            <div class="ml-2 flex items-center gap-2 text-xs text-slate-600">
                              <label for="pdf-quality">Quality</label>
                              <select id="pdf-quality" class="border border-slate-200 rounded px-1 py-0.5">
                                <option value="2">High (2x)</option>
                                <option value="1" selected>Standard (1x)</option>
                                <option value="0.5">Low (0.5x)</option>
                              </select>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden" data-testid="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner" data-testid="loading-spinner"></div>
            <p class="loading-text" data-testid="loading-message">AI is creating your chart...</p>
            <p class="loading-subtext">This usually takes 2-3 seconds</p>
        </div>
    </div>

    <!-- Main Scripts -->
    <script type="module" src="scripts/main.js"></script>
    
    <!-- Generator Script -->
    <script type="module">
        import { supabase } from '/src/supabase-client.js';
        import { ErrorTracker } from '/src/tracking/error-tracking.js';
        import { trackEvent } from '/src/tracking/analytics.js';
        import { exportChartToPDF } from '/src/utils/export-pdf.js';
        import { chartExporter } from '/src/utils/ChartExporter.js';
        import { AIRecommendations } from '/src/components/AIRecommendations.js';
        import { progressLoading } from '/src/components/ProgressLoadingManager.js';
        import { OptimizedChartTypeSelector } from '/src/components/OptimizedChartTypeSelector.js';

        // Simple script loader with caching
        const __loadedScripts = new Map();
        function ensureScriptOnce(src, globalVar) {
            if (__loadedScripts.has(src)) return __loadedScripts.get(src);
            const p = new Promise((resolve, reject) => {
                if (globalVar && window[globalVar]) return resolve(window[globalVar]);
                const s = document.createElement('script');
                s.src = src; s.async = true;
                s.onload = () => resolve(globalVar ? window[globalVar] : true);
                s.onerror = () => reject(new Error('Failed to load: ' + src));
                document.head.appendChild(s);
            });
            __loadedScripts.set(src, p);
            return p;
        }

        const COLOR_PALETTES = {
            default: ['#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#F97316'],
            vibrant: ['#EF4444', '#F97316', '#FACC15', '#10B981', '#6366F1', '#22D3EE'],
            professional: ['#1E40AF', '#0EA5E9', '#06B6D4', '#14B8A6', '#0369A1', '#0F172A'],
            monochrome: ['#111827', '#374151', '#6B7280', '#9CA3AF', '#D1D5DB', '#F3F4F6'],
            pastel: ['#DBEAFE', '#E0E7FF', '#FCE7F3', '#FEF3C7', '#DCFCE7', '#CCFBF1']
        };

        const CHART_PRESETS = {
            minimal: {
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                tension: 0.3,
                shadowBlur: 0
            },
            standard: {
                borderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 8,
                tension: 0.4,
                shadowBlur: 8
            },
            premium: {
                borderWidth: 4,
                pointRadius: 8,
                pointHoverRadius: 10,
                tension: 0.45,
                shadowOffsetX: 3,
                shadowOffsetY: 3,
                shadowBlur: 12,
                shadowColor: 'rgba(15, 23, 42, 0.15)'
            }
        };

        const numberFormatter = new Intl.NumberFormat('en-US', {
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        });

        // Register zoom plugin if available
        if (window.Chart) {
            try {
                const zoomPlugin = window['chartjs-plugin-zoom']?.default || window['chartjs-plugin-zoom'] || window.ChartZoom;
                if (zoomPlugin && typeof zoomPlugin === 'object') {
                    window.Chart.register(zoomPlugin);
                }

                window.Chart.defaults.font.family = "'Inter', sans-serif";
                window.Chart.defaults.color = '#0F172A';
            } catch (pluginError) {
                console.warn('Zoom plugin register failed:', pluginError);
            }
        }

        // Chart Generator Class
        class ChartGenerator {
            constructor() {
                this.currentChart = null;
                this.currentChartType = 'bar';
                this.currentLibrary = 'auto';
                this.profileSubscription = 'anon';
                this.isPro = false;
                this.initializeEventListeners();
                this.setupQuickPrompts();
                this.setupQuickActions();
                this.selectChartType(this.currentChartType);
                this.initializeExporter();
                this.initializeAIRecommendations();
                this.initializeSubscription();
            }

            async initializeExporter() {
                try {
                    // Get user data from auth service
                    const userData = await this.getUserData();
                    await chartExporter.initialize(userData);
                    
                    // Show limits notice for free users
                    if (!chartExporter.isPremium) {
                        chartExporter.showLimitsNotice();
                    }
                } catch (error) {
                    console.warn('Failed to initialize exporter:', error);
                }
            }

            initializeAIRecommendations() {
                this.aiRecommendations = new AIRecommendations(this);
            }

            async getUserData() {
                try {
                    // Try to get user from auth service
                    const { authService } = await import('/src/services/authService.js');
                    return await authService.getCurrentUser();
                } catch (error) {
                    // Return null if not authenticated
                    return null;
                }
            }

            initializeEventListeners() {
                // Generate button
                document.getElementById('generate-chart').addEventListener('click', () => {
                    this.generateChart();
                });

                // Library selector
                const libSel = document.getElementById('chart-library');
                if (libSel) {
                    libSel.addEventListener('change', (e) => {
                        const value = e.target.value;
                        if (['apexcharts','plotly'].includes(value) && !this.isPro) {
                            this.showUpgradeModal();
                            e.target.value = 'chartjs';
                            this.currentLibrary = 'chartjs';
                            return;
                        }
                        this.currentLibrary = value;
                    });
                }
                // Disable PRO-only libraries when not pro
                if (libSel && !this.isPro) {
                    Array.from(libSel.options).forEach((opt) => {
                        if (opt.getAttribute('data-pro-only') !== null) {
                            opt.disabled = true;
                            opt.textContent = (opt.textContent || '') + ' ‚Ä¢ PRO';
                        }
                    });
                }

                // Chart type selection with PRO gating
                const proOnlyTypes = ['sankey'];
                document.querySelectorAll('.chart-option').forEach(option => {
                    const type = option.dataset.type;
                    const isProOnly = proOnlyTypes.includes(type);
                    if (isProOnly && !this.isPro) {
                        option.dataset.proOnly = 'true';
                        option.classList.add('opacity-50', 'pointer-events-none', 'relative');
                        const badge = document.createElement('span');
                        badge.className = 'absolute top-1 right-1 text-[10px] bg-yellow-400 text-slate-900 rounded px-1 py-0.5';
                        badge.textContent = 'PRO';
                        option.appendChild(badge);
                        option.title = 'Unlock with Pro subscription';
                    }
                    option.addEventListener('click', () => {
                        if (option.dataset.proOnly === 'true' && !this.isPro) {
                            this.showUpgradeModal();
                            return;
                        }
                        this.selectChartType(type);
                    });
                });

                // Export buttons
                document.querySelectorAll('.export-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.exportChart(btn.dataset.format);
                    });
                });
                // Restrict export quality for non-pro
                const qSel = document.getElementById('pdf-quality');
                if (qSel && !this.isPro) {
                    Array.from(qSel.options).forEach((o) => {
                        if (o.value === '2') {
                            o.disabled = true;
                            if (o.selected) { qSel.value = '1'; }
                        }
                    });
                }

                // Refresh preview
                document.getElementById('refresh-preview').addEventListener('click', () => {
                    this.refreshPreview();
                });

                // Fullscreen preview
                document.getElementById('fullscreen-preview').addEventListener('click', () => {
                    this.toggleFullscreen();
                });

                const watchAdBtn = document.getElementById('watch-ad-btn');
                if (watchAdBtn) {
                    watchAdBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        this.handleWatchAd();
                    });
                }

                this.bindUpgradeButtons();
            }

            setupQuickPrompts() {
                document.querySelectorAll('.prompt-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const prompt = btn.dataset.prompt;
                        document.getElementById('prompt-input').value = prompt;
                        if (btn.dataset.type) {
                            this.selectChartType(btn.dataset.type);
                        }
                        try { trackEvent('template_used', { templateId: btn.dataset.type || 'prompt_suggestion' }); } catch {}
                        try { trackEvent('quick_prompt_used', { promptSnippet: (prompt || '').slice(0, 48) }); } catch {}
                        this.generateChart();
                    });
                });
            }

            setupQuickActions() {
                document.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const prompt = btn.dataset.prompt;
                        if (prompt) {
                            document.getElementById('prompt-input').value = prompt;
                        }

                        if (btn.dataset.type) {
                            this.selectChartType(btn.dataset.type);
                        }

                        try { trackEvent('template_used', { templateId: btn.dataset.type || 'quick_action' }); } catch {}
                        this.generateChart();
                    });
                });
            }

            selectChartType(type) {
                if (!type) return;
                this.currentChartType = type;
                document.querySelectorAll('.chart-option').forEach(option => {
                    option.classList.toggle('selected', option.dataset.type === type);
                });
                try { trackEvent('chart_type_selected', { chartType: type }); } catch {}
                this.refreshPreview();
            }

            async initializeSubscription() {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) { this.profileSubscription = 'anon'; this.isPro = false; return; }
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('subscription')
                        .eq('id', user.id)
                        .single();
                    if (!error && data?.subscription) {
                        this.profileSubscription = data.subscription;
                        this.isPro = String(data.subscription).toLowerCase() === 'pro';
                    } else {
                        this.profileSubscription = 'free';
                        this.isPro = false;
                    }
                } catch (e) {
                    this.profileSubscription = 'anon';
                    this.isPro = false;
                }
            }

            async generateChart() {
                const prompt = document.getElementById('prompt-input').value.trim();
                if (!prompt) {
                    alert('Please describe the chart you want to create');
                    return;
                }

                const loader = this.showLoading();

                const quota = await this.enforceQuota();
                if (!quota || quota.allowed === false) {
                    loader.hide();
                    return;
                }

                try {
                    const result = await client.generateChart({
                        prompt,
                        options: { enableCache: true, estimatedDuration: 10000 }
                    });

                    if (result.recommendations && result.recommendations.length > 0) {
                        this.handleAIRecommendations(result.recommendations, prompt);
                        const topRecommendation = result.recommendations[0];
                        this.currentChartType = topRecommendation;
                        this.selectChartType(topRecommendation);
                    }

                    await this.generateChartWithSpecificType(prompt, this.currentChartType);
                } catch (error) {
                    this.handleAIError(prompt, error, () => this.generateChart());
                } finally {
                    loader.hide();
                }
            }

            /**
             * Handle AI errors with actionable options
             * @param {string} prompt - Original prompt
             * @param {Object} error - Error object
             * @param {Function} onRetry - Retry callback
             */
            handleAIError(prompt, error, onRetry) {
                // Track error for analytics
                try {
                    trackEvent('ai_generation_error', {
                        error_code: error?.code,
                        error_message: error?.message,
                        prompt_length: prompt?.length || 0
                    });
                } catch (e) {}

                // Show enhanced error dialog
                progressLoading.showAIError(prompt, error, onRetry);
            }

            /**
             * Handle AI recommendations from the API response
             * @param {Array} recommendations - Array of recommended chart type IDs
             * @param {string} prompt - Original user prompt
             */
            handleAIRecommendations(recommendations, prompt) {
                try {
                    // Show AI recommendations UI
                    this.aiRecommendations.show(recommendations, prompt);
                    
                    // Track recommendation shown
                    if (typeof trackEvent === 'function') {
                        trackEvent('ai_recommendations_shown', {
                            recommendations: recommendations,
                            prompt_length: prompt.length,
                            top_recommendation: recommendations[0]
                        });
                    }
                } catch (error) {
                    console.warn('Failed to show AI recommendations:', error);
                }
            }

            /**
             * Generate chart with specific type
             * @param {string} prompt - User prompt
             * @param {string} chartType - Chart type to generate
             */
            async generateChartWithSpecificType(prompt, chartType) {
                try {
                    // Update current type
                    this.currentChartType = chartType;
                    
                    // Update progress to show we're generating with specific type
                    progressLoading.updateProgress('chart-generation', 70, `Generating ${chartType} chart...`);
                    
                    const result = await client.generateChart({
                        prompt,
                        chartType,
                        options: { enableCache: true, estimatedDuration: 8000 }
                    });

                    // Decide library
                    const lib = this.currentLibrary === 'auto' ? 'chartjs' : this.currentLibrary;
                    if (['apexcharts','plotly'].includes(lib) && !this.isPro) {
                        this.showUpgradeModal();
                        return;
                    }

                    // Render using selected library with fallback
                    const ok = await this.renderWithLibrary(lib, chartType, result?.data);
                    if (!ok) {
                        // Fallback to Chart.js
                        this.renderChart(result?.data);
                    }

                    // Progress + analytics
                    progressLoading.updateProgress('chart-generation', 100, 'Chart ready!');
                    try { 
                        trackEvent('chart_generated', { 
                            chartType, 
                            promptLength: prompt.length,
                            library: lib,
                            hasRecommendations: !!this.aiRecommendations.getCurrentSelection().wasOverridden
                        }); 
                    } catch {}
                } catch (error) {
                    throw error;
                }
            }

            async renderWithLibrary(lib, type, chartJsConfig) {
                try {
                    const container = document.getElementById('chart-container');
                    container.innerHTML = '';
                    // basic sample data if no config mapping
                    const sample = (typeof chartTypes !== 'undefined' && chartTypes.generateSampleData)
                        ? chartTypes.generateSampleData(type)
                        : { labels: ['A','B','C','D'], datasets: [{ label: 'Series', data: [12, 19, 3, 5] }] };

                    if (lib === 'chartjs') {
                        this.renderChart(chartJsConfig);
                        return true;
                    }

                    if (lib === 'echarts') {
                        await ensureScriptOnce('https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js', 'echarts');
                        const el = document.createElement('div');
                        el.style.width = '100%'; el.style.height = '360px';
                        container.appendChild(el);
                        const inst = window.echarts.init(el);
                        const option = this.buildEChartsOption(type, sample);
                        inst.setOption(option);
                        this.currentChart = inst;
                        this.maybeShowWatermark(container);
                        return true;
                    }

                    if (lib === 'apexcharts') {
                        await ensureScriptOnce('https://cdn.jsdelivr.net/npm/apexcharts', 'ApexCharts');
                        const el = document.createElement('div');
                        container.appendChild(el);
                        const options = this.buildApexOption(type, sample);
                        const chart = new window.ApexCharts(el, options);
                        await chart.render();
                        this.currentChart = chart;
                        this.maybeShowWatermark(container);
                        return true;
                    }

                    if (lib === 'plotly') {
                        await ensureScriptOnce('https://cdn.plot.ly/plotly-2.27.0.min.js', 'Plotly');
                        const el = document.createElement('div');
                        container.appendChild(el);
                        const payload = this.buildPlotlyPayload(type, sample);
                        await window.Plotly.newPlot(el, payload.data, payload.layout, { displayModeBar: true });
                        this.currentChart = el;
                        this.maybeShowWatermark(container);
                        return true;
                    }

                    return false;
                } catch (e) {
                    console.warn('Library render failed, falling back to Chart.js', e);
                    return false;
                }
            }

            buildEChartsOption(type, sample) {
                const { labels, datasets } = sample;
                const data = datasets[0]?.data || [];
                if (['bar','line','area'].includes(type)) {
                    return {
                        tooltip: {}, xAxis: { type: 'category', data: labels }, yAxis: { type: 'value' },
                        series: [{ type: type === 'area' ? 'line' : type, data, areaStyle: type==='area'?{}:undefined }]
                    };
                }
                if (['pie','doughnut'].includes(type)) {
                    return {
                        tooltip: {}, series: [{ type: 'pie', radius: type==='doughnut'?['40%','70%']:'55%', data: labels.map((l,i)=>({ name:l, value:data[i]||0 })) }]
                    };
                }
                return { title: { text: 'Chart' } };
            }

            buildApexOption(type, sample) {
                const { labels, datasets } = sample;
                const data = datasets[0]?.data || [];
                if (['bar','line','area'].includes(type)) {
                    return { chart: { type: type==='area'?'area':type }, series:[{ name: datasets[0]?.label||'Series', data }], xaxis:{ categories: labels } };
                }
                if (['pie','doughnut'].includes(type)) {
                    return { chart:{ type:'donut' }, labels, series: data };
                }
                return { chart:{ type:'line' }, series:[{ data }], xaxis:{ categories: labels } };
            }

            buildPlotlyPayload(type, sample) {
                const { labels, datasets } = sample;
                const data = datasets[0]?.data || [];
                if (['bar'].includes(type)) {
                    return { data:[{ type:'bar', x: labels, y: data }], layout:{ margin:{ t:20 } } };
                }
                if (['line','area'].includes(type)) {
                    return { data:[{ type:'scatter', mode:'lines', fill: type==='area'?'tozeroy':'none', x: labels, y: data }], layout:{ margin:{ t:20 } } };
                }
                if (['pie','doughnut'].includes(type)) {
                    return { data:[{ type:'pie', labels, values: data, hole: type==='doughnut'?0.5:0 }], layout:{ margin:{ t:20 } } };
                }
                return { data:[{ type:'scatter', x: labels, y: data }], layout:{ margin:{ t:20 } } };
            }

            showUpgradeModal() {
                if (document.getElementById('pro-overlay')) return;
                const overlay = document.createElement('div');
                overlay.id = 'pro-overlay';
                overlay.className = 'fixed inset-0 z-50 bg-black/70 flex items-center justify-center';
                const dialog = document.createElement('div');
                dialog.className = 'bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 text-center space-y-6';
                dialog.innerHTML = `
                    <div class="text-4xl">üöÄ</div>
                    <h3 class="text-xl font-semibold text-slate-900">Unlock Pro Libraries</h3>
                    <p class="text-slate-600">Access Plotly, ApexCharts, advanced features, and unlimited generations.</p>
                    <div class="space-y-3">
                        <button class="ui-btn ui-btn-primary w-full" data-action="upgrade-pro">Upgrade to Pro</button>
                        <a href="/pricing.html" class="ui-btn ui-btn-secondary w-full">View Pricing</a>
                        <button id="close-pro-overlay" class="w-full border border-slate-200 text-slate-700 rounded-lg py-2">Not now</button>
                    </div>`;
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                dialog.querySelector('#close-pro-overlay').addEventListener('click', ()=> overlay.remove());
                overlay.addEventListener('click', (e)=> { if (e.target===overlay) overlay.remove(); });
                this.bindUpgradeButtons(overlay);
            }

            renderChart(data) {
                const container = document.getElementById('chart-container');
                container.innerHTML = '';
                if (!data || !data.type) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'No chart configuration returned.';
                    container.appendChild(div);
                    return;
                }
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                // Destroy previous chart if any
                if (this.currentChart && this.currentChart.destroy) {
                    try { this.currentChart.destroy(); } catch {}
                }
                // Create Chart.js instance from config
                this.currentChart = new Chart(ctx, data);
                this.maybeShowWatermark(container);
            }

            renderChartFromConfig(config) {
                const container = document.getElementById('chart-container');
                container.innerHTML = '';
                if (!config || !config.type) {
                    const div = document.createElement('div');
                    div.className = 'text-slate-600';
                    div.textContent = 'No chart configuration returned.';
                    container.appendChild(div);
                    return;
                }
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                // Destroy previous chart if any
                if (this.currentChart && this.currentChart.destroy) {
                    try { this.currentChart.destroy(); } catch {}
                }
                // Create Chart.js instance from config
                this.currentChart = new Chart(ctx, config);
                this.maybeShowWatermark(container);
            }

            createChart(type, quotaResult) {
                const container = document.getElementById('chart-container');
                container.innerHTML = ''; // Clear previous chart

                if (quotaResult?.shouldShowAd) {
                    this.showAdOverlay();
                }

                // Create chart based on type
                if (['bar', 'line', 'pie', 'doughnut', 'area', 'scatter', 'bubble', 'radar', 'polar'].includes(type)) {
                    this.createChartJSChart(type);
                } else if (['force', 'treemap', 'sankey'].includes(type)) {
                    this.createD3Chart(type);
                }
            }

            async enforceQuota() {
                try {
                    const response = await fetch('/.netlify/functions/check-quota', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action: 'generate-chart' })
                    });

                    if (!response.ok) {
                        throw new Error('Quota check failed');
                    }

                    const result = await response.json();
                    this.updateQuotaBanner(result);

                    if (!result.allowed) {
                        alert(result.message || 'Daily generation limit reached.');
                        return result;
                    }

                    return result;
                } catch (error) {
                    console.warn('Quota check unavailable, proceeding without limits.', error);
                    return { allowed: true, shouldShowAd: false };
                }
            }

            updateQuotaBanner(result) {
                const banner = document.getElementById('quota-banner');
                const message = document.getElementById('quota-banner-message');
                const watchAdBtn = document.getElementById('watch-ad-btn');

                if (!banner || !message) return;

                if (result && result.bannerText) {
                    message.textContent = result.bannerText;
                } else {
                    message.textContent = `You have ${result?.remaining ?? 'unknown'} generations left today.`;
                }

                if (result && result.showBanner) {
                    banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                }

                if (watchAdBtn) {
                    watchAdBtn.disabled = !result?.canWatchAd;
                }
            }

            handleWatchAd() {
                this.showAdOverlay();
                document.dispatchEvent(new CustomEvent('billing:watchAd'));
            }

            bindUpgradeButtons(root = document) {
                const scope = root || document;
                scope.querySelectorAll('[data-action="upgrade-pro"]').forEach((btn) => {
                    if (btn.dataset.upgradeBound === 'true') return;
                    btn.dataset.upgradeBound = 'true';
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        document.dispatchEvent(new CustomEvent('billing:upgrade'));
                    });
                });
            }

            showAdOverlay() {
                if (document.getElementById('ad-overlay')) {
                    return;
                }

                const overlay = document.createElement('div');
                overlay.id = 'ad-overlay';
                overlay.className = 'fixed inset-0 z-50 bg-black/70 flex items-center justify-center';

                const dialog = document.createElement('div');
                dialog.className = 'bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-8 text-center space-y-6';
                overlay.appendChild(dialog);

                const icon = document.createElement('div');
                icon.className = 'text-4xl';
                icon.textContent = 'üì∫';
                dialog.appendChild(icon);

                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold text-slate-900';
                title.textContent = 'Enjoy a quick break!';
                dialog.appendChild(title);

                const description = document.createElement('p');
                description.className = 'text-slate-600';
                description.textContent = 'A short ad is playing so you can unlock the next chart. Upgrade to Pro to remove ads and limits.';
                dialog.appendChild(description);

                const actions = document.createElement('div');
                actions.className = 'space-y-3';
                dialog.appendChild(actions);

                const upgradeBtn = document.createElement('button');
                upgradeBtn.className = 'w-full px-4 py-3 bg-slate-900 text-white rounded-lg font-semibold hover:bg-slate-800 transition';
                upgradeBtn.dataset.action = 'upgrade-pro';
                upgradeBtn.textContent = 'Upgrade to Pro';
                actions.appendChild(upgradeBtn);

                const closeBtn = document.createElement('button');
                closeBtn.id = 'close-ad-overlay';
                closeBtn.className = 'w-full px-4 py-3 border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition';
                closeBtn.textContent = 'Close';
                actions.appendChild(closeBtn);

                document.body.appendChild(overlay);

                closeBtn.addEventListener('click', () => {
                    overlay.remove();
                });

                overlay.addEventListener('click', (event) => {
                    if (event.target === overlay) {
                        overlay.remove();
                    }
                });

                this.bindUpgradeButtons(overlay);
            }

            createChartJSChart(type) {
                const container = document.getElementById('chart-container');
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);

                const ctx = canvas.getContext('2d');
                const data = chartTypes.generateSampleData(type);

                let chart;
                switch (type) {
                    case 'bar':
                        chart = chartTypes.createBarChart(ctx, data);
                        break;
                    case 'line':
                        chart = chartTypes.createLineChart(ctx, data);
                        break;
                    case 'area':
                        chart = chartTypes.createAreaChart(ctx, data);
                        break;
                    case 'pie':
                        chart = chartTypes.createPieChart(ctx, data);
                        break;
                    case 'doughnut':
                        chart = chartTypes.createDoughnutChart(ctx, data);
                        break;
                    case 'scatter':
                        chart = chartTypes.createScatterChart(ctx, data);
                        break;
                    case 'bubble':
                        chart = chartTypes.createBubbleChart(ctx, data);
                        break;
                    case 'radar':
                        chart = chartTypes.createRadarChart(ctx, data);
                        break;
                    case 'polar':
                        chart = chartTypes.createPolarAreaChart(ctx, data);
                        break;
                }

                this.currentChart = chart;
            }

            createD3Chart(type) {
                const container = document.getElementById('chart-container');
                const data = d3Visualizations.generateSampleData(type);

                let viz;
                switch (type) {
                    case 'force':
                        viz = d3Visualizations.createForceGraph('chart-container', data.nodes, data.links, {
                            width: 350,
                            height: 300
                        });
                        break;
                    case 'treemap':
                        viz = d3Visualizations.createTreeMap('chart-container', data, {
                            width: 350,
                            height: 300
                        });
                        break;
                    case 'sankey':
                        viz = d3Visualizations.createSankeyDiagram('chart-container', data, {
                            width: 350,
                            height: 300
                        });
                        break;
                }

                this.currentChart = viz;
            }

            exportChart(format) {
                if (!this.currentChart) {
                    alert('Please generate a chart first');
                    return;
                }

                // Export based on format
                switch (format) {
                    case 'png':
                        this.exportAsPNG();
                        break;
                    case 'svg':
                        this.exportAsSVG();
                        break;
                    case 'pdf':
                        this.exportAsPDF();
                        break;
                    case 'html':
                        this.exportAsHTML();
                        break;
                }
            }

            exportAsPNG() {
                if (this.currentChart.canvas) {
                    const link = document.createElement('a');
                    link.download = 'chart.png';
                    link.href = this.currentChart.toBase64Image();
                    link.click();
                    try { trackEvent('chart_exported', { format: 'png' }); } catch {}
                }
            }

            exportAsSVG() {
                // For D3 charts
                if (this.currentChart && this.currentChart.svg) {
                    const svgData = this.currentChart.svg.node().outerHTML;
                    const blob = new Blob([svgData], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'chart.svg';
                    link.href = url;
                    link.click();
                    try { trackEvent('chart_exported', { format: 'svg' }); } catch {}
                }
            }

            exportAsPDF() {
                const container = document.getElementById('chart-container');
                const qualitySel = document.getElementById('pdf-quality');
                const scale = qualitySel ? Number(qualitySel.value) : 1;
                if (!container) {
                    alert('Chart container not found');
                    return;
                }
                exportChartToPDF(container, {
                    filename: 'vizom-chart.pdf',
                    orientation: 'landscape',
                    quality: 0.95,
                    scale
                })
                .then(() => { try { trackEvent('chart_exported', { format: 'pdf' }); } catch {} })
                .catch((error) => {
                    try { ErrorTracker.trackError(error, { context: 'pdf-export' }); } catch {}
                    alert('Failed to export PDF. Please try again.');
                });
            }

            exportAsHTML() {
                const htmlContent = this.generateHTMLCode();
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = 'chart.html';
                link.href = url;
                link.click();
                try { trackEvent('chart_exported', { format: 'html' }); } catch {}
            }

            generateHTMLCode() {
                return `
<!DOCTYPE html>
<html>
<head>
    <title>Generated Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>
<\/head>
<body>
    <canvas id="chart" width="400" height="300"><\/canvas>
    <script>
        // Chart code would go here
    <\/script>
<\/body>
<\/html>`;
            }

            refreshPreview() {
                if (this.currentChartType) {
                    this.createChart(this.currentChartType);
                }
            }

            toggleFullscreen() {
                const container = document.getElementById('chart-container');
                if (!document.fullscreenElement) {
                    container.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            showLoading() {
                const prompt = document.getElementById('prompt-input')?.value || '';
                return progressLoading.showLoading('chart-generation', {
                    title: 'AI is generating your chart',
                    description: 'This usually takes 5-10 seconds',
                    animation: 'chart',
                    friendlyMessages: [
                        "Analyzing your data patterns... üìä",
                        "Finding the perfect visualization... üéØ",
                        "Creating beautiful charts... ‚ú®",
                        "Almost ready... üöÄ"
                    ]
                });
            }

            hideLoading() {
                progressLoading.hideLoading('chart-generation');
            }

            showSuccess() {
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4';
                successMsg.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle"></i>
                        <span>Chart generated successfully!</span>
                    </div>
                `;
                
                // Insert after chart preview
                const previewPanel = document.querySelector('.preview-panel');
                if (previewPanel) {
                    previewPanel.insertBefore(successMsg, previewPanel.firstChild);
                    
                    // Auto-remove after 3 seconds
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.remove();
                        }
                    }, 3000);
                }
            }

            handleError(error) {
                console.error('Chart generation error:', error);
                
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4';
                errorMsg.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Failed to generate chart: ${error.message || 'Unknown error'}</span>
                    </div>
                `;
                
                // Insert after chart preview
                const previewPanel = document.querySelector('.preview-panel');
                if (previewPanel) {
                    previewPanel.insertBefore(errorMsg, previewPanel.firstChild);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        if (errorMsg.parentNode) {
                            errorMsg.remove();
                        }
                    }, 5000);
                }
            }
        }

        // Initialize the generator when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new ChartGenerator();

            // Prefill prompt from URL param and show tooltip
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const promptFromUrl = urlParams.get('prompt');
                if (promptFromUrl) {
                    const promptInput = document.getElementById('prompt-input');
                    if (promptInput) {
                        promptInput.value = promptFromUrl;
                        // Track prefill source
                        try { trackEvent('generator_prefilled', { source: 'landing' }); } catch {}
                        // Inject tooltip and animation
                        showTooltip();
                        try { updateButtonState(); } catch {}
                    }
                }
            } catch {}

            // Track export attempts pre-action
            try {
                document.querySelectorAll('.export-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const fmt = btn.dataset.format || 'unknown';
                        try { trackEvent('export_attempt', { format: fmt }); } catch {}
                    });
                });
            } catch {}

            // ===== Prompt validation & button disable =====
            try {
                const vStyleId = 'vizom-prompt-validation';
                if (!document.getElementById(vStyleId)) {
                    const st = document.createElement('style');
                    st.id = vStyleId;
                    st.textContent = `#prompt-input.invalid{border-color:#EF4444} #prompt-input.valid{border-color:#10B981} #generate-chart:disabled{opacity:.5;cursor:not-allowed}`;
                    document.head.appendChild(st);
                }

                const promptInput = document.getElementById('prompt-input');
                const generateBtn = document.getElementById('generate-chart');
                const helperText = document.getElementById('prompt-helper');

                function updateButtonState() {
                    const value = String(promptInput?.value || '').trim();
                    const isValid = value.length >= 3 && value.length <= 500;
                    if (generateBtn) generateBtn.disabled = !isValid;

                    if (promptInput) {
                        promptInput.classList.toggle('invalid', !isValid && value.length > 0);
                        promptInput.classList.toggle('valid', isValid);
                    }

                    if (helperText) {
                        if (isValid) {
                            helperText.textContent = 'Press Enter or click Generate';
                            helperText.classList.remove('text-red-600');
                            helperText.classList.add('text-gray-600');
                        } else {
                            if (value.length === 0) {
                                helperText.textContent = 'Describe your chart in plain English';
                                helperText.classList.remove('text-red-600');
                                helperText.classList.add('text-gray-600');
                            } else if (value.length < 3) {
                                helperText.textContent = 'Please enter at least 3 characters';
                                helperText.classList.add('text-red-600');
                                helperText.classList.remove('text-gray-600');
                            } else if (value.length > 500) {
                                helperText.textContent = 'Prompt is too long (max 500 characters)';
                                helperText.classList.add('text-red-600');
                                helperText.classList.remove('text-gray-600');
                            }
                        }
                    }
                }

                function validatePrompt() {
                    const value = String(promptInput?.value || '').trim();
                    if (!helperText) return;
                    if (value.length === 0) {
                        helperText.textContent = 'Describe your chart in plain English';
                        helperText.classList.remove('text-red-600');
                        helperText.classList.add('text-gray-600');
                    } else if (value.length < 3) {
                        helperText.textContent = 'Please be more specific (min 3 characters)';
                        helperText.classList.add('text-red-600');
                        helperText.classList.remove('text-gray-600');
                    } else if (value.length > 500) {
                        helperText.textContent = 'Prompt is too long (max 500 characters)';
                        helperText.classList.add('text-red-600');
                        helperText.classList.remove('text-gray-600');
                    } else {
                        helperText.textContent = `${500 - value.length} characters remaining`;
                        helperText.classList.remove('text-red-600');
                        helperText.classList.add('text-gray-600');
                    }
                }

                if (promptInput) {
                    promptInput.addEventListener('input', updateButtonState);
                    promptInput.addEventListener('blur', validatePrompt);
                }
                if (generateBtn) {
                    generateBtn.addEventListener('click', (e) => {
                        const value = String(promptInput?.value || '').trim();
                        if (value.length < 3) {
                            e.preventDefault();
                            promptInput?.focus();
                            if (helperText) {
                                helperText.textContent = 'Please enter a chart description';
                                helperText.classList.add('text-red-600');
                                helperText.classList.remove('text-gray-600');
                            }
                        }
                    });
                }

                // Initial state
                updateButtonState();
            } catch {}
        });

        function showTooltip() {
            const existing = document.getElementById('vizom-prefill-tip');
            if (existing) existing.remove();
            // Ensure animation keyframes exist
            const styleId = 'vizom-tooltip-anim';
            if (!document.getElementById(styleId)) {
                const st = document.createElement('style');
                st.id = styleId;
                st.textContent = `@keyframes viz-bounce {0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-10px)}} .viz-animate-bounce{animation:viz-bounce 1s ease-in-out 3}`;
                document.head.appendChild(st);
            }
            const tip = document.createElement('div');
            tip.id = 'vizom-prefill-tip';
            tip.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 viz-animate-bounce';
            tip.textContent = 'üëá Click "Generate" to create your chart!';
            document.body.appendChild(tip);
            setTimeout(() => {
                tip.style.transition = 'opacity .3s ease';
                tip.style.opacity = '0';
                setTimeout(() => tip.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>

  <!-- Projects Modal -->
  <div id="projects-modal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b border-slate-200">
        <h3 class="text-xl font-semibold text-slate-900">–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h3>
        <button id="close-projects-modal" class="text-slate-400 hover:text-slate-600 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6 overflow-y-auto max-h-[60vh]">
        <div id="projects-list" class="grid gap-4">
          <!-- Projects will be dynamically loaded here -->
        </div>
        <div id="no-projects" class="hidden text-center py-12">
          <i class="fas fa-folder-open text-4xl text-slate-300 mb-4"></i>
          <p class="text-slate-500">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
          <p class="text-sm text-slate-400 mt-2">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Project Modal -->
  <div id="save-project-modal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold text-slate-900">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</h3>
        <button id="close-save-modal" class="text-slate-400 hover:text-slate-600 transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium text-slate-700">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
        <input type="text" id="project-title" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="–ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏ Q1 2024">
      </div>
      <div class="flex gap-3">
        <button id="confirm-save-project" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button id="cancel-save-project" class="flex-1 border border-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:border-slate-300 transition">
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="auth-modal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold text-slate-900">–í—Ö–æ–¥ –≤ VIZOM</h3>
        <button id="close-auth-modal" class="text-slate-400 hover:text-slate-600 transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="text-sm text-slate-500">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—É –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π</p>
      <button id="google-signin" class="w-full inline-flex items-center justify-center gap-2 bg-white border border-slate-200 text-slate-700 px-4 py-3 rounded-lg hover:bg-slate-50 transition">
        <svg class="w-5 h-5" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continue with Google
      </button>
    </div>
  </div>

  </main>

  <!-- Unified Footer -->
  <footer id="unified-footer">
    <!-- Footer content will be dynamically loaded by UnifiedFooter.js -->
  </footer>

  <link rel="stylesheet" href="src/styles/components/footer.css">

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏ –º–æ–¥—É–ª–µ–π -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
  <script>
    // Enhanced loading functions using the LoadingStatesManager
    function showLoading(id = 'chart-generation', config = {}) {
      if (window.loadingStates) {
        const defaultConfig = {
          title: 'AI is generating your chart',
          description: 'This usually takes 5-10 seconds',
          progressBar: true,
          steps: true,
          stepTexts: [
            { text: 'Processing your input', threshold: 30 },
            { text: 'Generating visualization', threshold: 70 },
            { text: 'Finalizing chart', threshold: 100 }
          ],
          showCancel: true,
          timeout: 30000
        };
        
        return window.loadingStates.showLoading(id, { ...defaultConfig, ...config });
      } else {
        // Fallback to basic loading
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.remove('hidden');
          return { hide: () => overlay.classList.add('hidden') };
        }
      }
    }

    function hideLoading(id = 'chart-generation') {
      if (window.loadingStates) {
        return window.loadingStates.hideLoading(id);
      } else {
        // Fallback to basic loading
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.classList.add('hidden');
        }
        return true;
      }
    }

    function updateProgress(id, progress, text) {
      if (window.loadingStates) {
        return window.loadingStates.updateProgress(id, progress, text);
      }
      return false;
    }

    // Example usage with Smart Parse button
    document.addEventListener('DOMContentLoaded', () => {
      const smartParseBtn = document.getElementById('smart-parse-btn');
      
      if (smartParseBtn) {
        smartParseBtn.addEventListener('click', () => {
          // Check if input is ready for generation
          const isReady = window.inputValidation?.isReadyForGeneration('prompt-input');
          
          if (!isReady) {
            // Show validation feedback instead of loading
            const feedback = document.getElementById('input-feedback');
            if (feedback && feedback.classList.contains('hidden')) {
              window.inputValidation?.validate('prompt-input', 'input-feedback');
            }
            return;
          }
          
          // Show enhanced loading
          const loader = showLoading('chart-generation', {
            title: 'AI is generating your chart',
            description: 'Analyzing your data and creating the perfect visualization...',
            steps: true,
            progressBar: true
          });
          
          // Simulate progress updates
          let progress = 0;
          const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            
            if (progress < 30) {
              updateProgress('chart-generation', progress, 'Processing your input...');
            } else if (progress < 70) {
              updateProgress('chart-generation', progress, 'Generating visualization...');
            } else if (progress < 100) {
              updateProgress('chart-generation', progress, 'Finalizing chart...');
            } else {
              progress = 100;
              updateProgress('chart-generation', progress, 'Complete!');
              clearInterval(progressInterval);
              
              // Hide loading after completion
              setTimeout(() => {
                hideLoading('chart-generation');
              }, 1000);
            }
          }, 300);
          
          // Simulate completion after 5 seconds
          setTimeout(() => {
            clearInterval(progressInterval);
            updateProgress('chart-generation', 100, 'Chart generated successfully!');
            setTimeout(() => {
              hideLoading('chart-generation');
            }, 1000);
          }, 5000);
        });
      }

      // Listen for validation events
      document.addEventListener('input:validated', (e) => {
        const { validation } = e.detail;
        
        // Enable/disable smart parse button based on validation
        const smartParseBtn = document.getElementById('smart-parse-btn');
        if (smartParseBtn) {
          if (validation.isValid && validation.score >= 70) {
            smartParseBtn.disabled = false;
            smartParseBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          } else {
            smartParseBtn.disabled = true;
            smartParseBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        }
      });

      // Example with file upload
      const csvUpload = document.getElementById('csv-upload');
      if (csvUpload) {
        csvUpload.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            const loader = showLoading('file-upload', {
              title: 'Processing your file',
              description: 'Analyzing CSV data and preparing for visualization...',
              progressBar: true,
              steps: false
            });
            
            // Simulate file processing
            setTimeout(() => {
              hideLoading('file-upload');
            }, 3000);
          }
        });
      }

      // Example with project save
      const saveProjectBtn = document.getElementById('save-project');
      if (saveProjectBtn) {
        saveProjectBtn.addEventListener('click', () => {
          const buttonLoader = window.loadingStates?.showButtonLoading(saveProjectBtn, 'Saving...');
          
          setTimeout(() => {
            if (buttonLoader) {
              buttonLoader.hide();
            }
          }, 2000);
        });
      }

      // Clear input functionality
      const clearBtn = document.getElementById('clear-input');
      const textarea = document.getElementById('prompt-input');
      
      if (clearBtn && textarea) {
        clearBtn.addEventListener('click', () => {
          textarea.value = '';
          window.inputValidation?.validate('prompt-input', 'input-feedback');
          window.inputValidation?.updateCharCount(textarea, 'char-count');
          textarea.focus();
        });
      }
    });

    // Global error handling for loading timeouts
    window.addEventListener('error', (e) => {
      // Hide any active loading states on error
      if (window.loadingStates) {
        const activeLoaders = window.loadingStates.getActiveLoaders();
        activeLoaders.forEach(id => {
          window.loadingStates.hideLoading(id);
        });
      }
    });
  </script>
  
  <!-- Mobile Menu Script -->
  <script>
    // Mobile menu toggle
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const navLinks = document.getElementById('nav-links');
    
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');
            const icon = mobileMenuToggle.querySelector('i');
            icon.classList.toggle('fa-bars');
            icon.classList.toggle('fa-times');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav') && navLinks.classList.contains('active')) {
                navLinks.classList.remove('active');
                const icon = mobileMenuToggle.querySelector('i');
                icon.classList.add('fa-bars');
                icon.classList.remove('fa-times');
            }
        });
        
        // Close menu when clicking a link
        navLinks.querySelectorAll('a, button').forEach(link => {
            link.addEventListener('click', () => {
                navLinks.classList.remove('active');
                const icon = mobileMenuToggle.querySelector('i');
                icon.classList.add('fa-bars');
                icon.classList.remove('fa-times');
            });
        });
    }
  </script>
</body>
</html>
